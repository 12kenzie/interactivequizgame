<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Group 4 MIL PeTa Game</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Press Start 2P', monospace;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background-color: #000;
      color: #fff;
      overflow: hidden;
      height: 100vh;
      touch-action: none;
    }

    #game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      background-color: #000;
    }

    canvas {
      display: block;
      background-color: #000;
      image-rendering: pixelated;
    }

    .ui-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .ui-overlay>* {
      pointer-events: auto;
    }

    .score-display {
      position: absolute;
      top: 10px;
      right: 10px;
      color: #fff;
      font-size: 10px;
      text-shadow: 2px 2px #000;
      z-index: 500;
    }

    .controls-hint {
      position: absolute;
      top: 10px;
      left: 10px;
      color: #fff;
      font-size: 7px;
      line-height: 1.8;
      text-shadow: 2px 2px #000;
      z-index: 500;
    }

    .audio-control {
      position: absolute;
      top: 50px;
      right: 10px;
      background-color: #000;
      color: #fff;
      border: 2px solid #fff;
      padding: 8px 12px;
      font-size: 7px;
      cursor: pointer;
      transition: all 0.1s;
      z-index: 500;
    }

    .audio-control:hover,
    .audio-control:active {
      background-color: #ff8c00;
      color: #000;
      border-color: #ff8c00;
    }

    .mobile-controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      gap: 15px;
      z-index: 500;
    }

    .mobile-dpad {
      display: grid;
      grid-template-areas: ". up ." "left . right" ". down .";
      gap: 5px;
      width: 150px;
      height: 150px;
    }

    .mobile-btn {
      background-color: rgba(0, 0, 0, 0.7);
      border: 3px solid #fff;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      touch-action: none;
    }

    .mobile-btn:active {
      background-color: #ff8c00;
      border-color: #ff8c00;
    }

    .mobile-btn.up {
      grid-area: up;
    }

    .mobile-btn.down {
      grid-area: down;
    }

    .mobile-btn.left {
      grid-area: left;
    }

    .mobile-btn.right {
      grid-area: right;
    }

    .mobile-action {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background-color: rgba(0, 0, 0, 0.7);
      border: 3px solid #fff;
      color: #fff;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      touch-action: none;
    }

    .mobile-action:active {
      background-color: #ff8c00;
      border-color: #ff8c00;
    }

    @media (max-width: 768px) {
      .mobile-controls {
        display: flex;
      }

      .controls-hint {
        display: none;
      }

      .score-display {
        font-size: 8px;
      }
    }

    .name-input-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .name-input-screen.hidden {
      display: none;
    }

    .name-input-box {
      background-color: #000;
      border: 6px solid #fff;
      padding: 20px;
      max-width: 600px;
      width: 100%;
      text-align: center;
    }

    .name-input-box h2 {
      color: #fff;
      font-size: 12px;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .name-display {
      background-color: #000;
      border: 4px solid #fff;
      padding: 15px;
      font-size: 18px;
      color: #fff;
      text-align: center;
      min-height: 50px;
      margin: 15px 0;
      letter-spacing: 8px;
    }

    .keyboard-container {
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      gap: 5px;
      margin: 15px 0;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }

    @media (max-width: 768px) {
      .keyboard-container {
        grid-template-columns: repeat(7, 1fr);
        gap: 3px;
      }

      .name-display {
        font-size: 14px;
      }
    }

    .key-button {
      background-color: #000;
      color: #fff;
      border: 2px solid #fff;
      padding: 10px;
      font-size: 9px;
      cursor: pointer;
      transition: all 0.1s;
    }

    .key-button:hover:not(:disabled),
    .key-button:active:not(:disabled) {
      background-color: #ff8c00;
      color: #000;
      border-color: #ff8c00;
    }

    .key-button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .name-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .name-control-btn {
      background-color: #000;
      color: #fff;
      border: 3px solid #fff;
      padding: 12px 20px;
      font-size: 9px;
      cursor: pointer;
      transition: all 0.1s;
    }

    .name-control-btn:hover:not(:disabled),
    .name-control-btn:active:not(:disabled) {
      background-color: #ff8c00;
      color: #000;
      border-color: #ff8c00;
    }

    .name-control-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .tips-selection-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      display: none;
      z-index: 900;
      padding: 20px;
      overflow-y: auto;
    }

    .tips-selection-screen.active {
      display: block;
    }

    .tips-selection-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    .tips-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .tips-header h2 {
      color: #ff8c00;
      font-size: 16px;
      margin-bottom: 15px;
    }

    .tips-header p {
      color: #fff;
      font-size: 10px;
      line-height: 1.8;
    }

    .tips-grid {
      display: grid;
      gap: 20px;
      margin-bottom: 30px;
    }

    .tip-card {
      background-color: #000;
      border: 4px solid #666;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .tip-card:hover {
      border-color: #ff8c00;
      transform: translateY(-5px);
    }

    .tip-card.collected {
      border-color: #0f0;
      background-color: #001100;
    }

    .tip-card.collected::after {
      content: '‚úì COLLECTED';
      position: absolute;
      top: 10px;
      right: 10px;
      color: #0f0;
      font-size: 8px;
    }

    .tip-title {
      color: #ff8c00;
      font-size: 11px;
      margin-bottom: 10px;
    }

    .tip-subtitle {
      color: #ffff00;
      font-size: 8px;
      margin-bottom: 10px;
      font-style: italic;
    }

    .tip-content {
      color: #fff;
      font-size: 9px;
      line-height: 1.6;
    }

    .tip-category {
      color: #ff8c00;
      font-size: 12px;
      margin: 30px 0 15px 0;
      border-bottom: 2px solid #ff8c00;
      padding-bottom: 10px;
    }

    .tips-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 30px;
    }

    .tips-action-btn {
      background-color: #000;
      color: #fff;
      border: 4px solid #fff;
      padding: 15px 30px;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tips-action-btn:hover {
      background-color: #ff8c00;
      color: #000;
      border-color: #ff8c00;
      transform: scale(1.05);
    }

    .tips-action-btn.primary {
      border-color: #0f0;
      color: #0f0;
    }

    .tips-action-btn.primary:hover {
      background-color: #0f0;
      color: #000;
    }

    @media (max-width: 768px) {
      .tips-header h2 {
        font-size: 12px;
      }

      .tips-header p {
        font-size: 8px;
      }

      .tip-card {
        padding: 15px;
      }

      .tip-title {
        font-size: 9px;
      }

      .tip-content {
        font-size: 8px;
      }

      .tips-action-btn {
        padding: 12px 20px;
        font-size: 8px;
      }
    }

    #battle-box {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 800px;
      min-height: 350px;
      background-color: #000;
      border: 6px solid #fff;
      padding: 25px;
      display: none;
      z-index: 100;
    }

    #battle-box.active {
      display: block;
    }

    @media (max-width: 768px) {
      #battle-box {
        width: 95%;
        min-height: 300px;
        padding: 15px;
        bottom: 180px;
      }
    }

    .stats-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      font-size: 10px;
      flex-wrap: wrap;
    }

    .hp-bar-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .hp-bar-outer {
      background-color: #8b0000;
      width: 120px;
      height: 20px;
      border: 2px solid #fff;
      position: relative;
    }

    .hp-bar-inner {
      background-color: #ff0;
      height: 100%;
      width: 100%;
      transition: width 0.3s ease;
    }

    .question-text {
      color: #fff;
      font-size: 14px;
      line-height: 1.8;
      margin-bottom: 25px;
      min-height: 100px;
    }

    @media (max-width: 768px) {
      .question-text {
        font-size: 11px;
      }
    }

    .answer-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .answer-buttons {
        grid-template-columns: 1fr;
      }
    }

    .answer-btn {
      background-color: #000;
      color: #ff8c00;
      border: 3px solid #ff8c00;
      padding: 18px;
      font-size: 11px;
      cursor: pointer;
      text-align: left;
      transition: all 0.1s;
      font-weight: bold;
    }

    .answer-btn:hover:not(:disabled) {
      background-color: #ffa500;
      color: #000;
      border-color: #ffa500;
    }

    .answer-btn.correct {
      background-color: #0f0;
      color: #000;
      border-color: #0f0;
    }

    .answer-btn.wrong {
      background-color: #f00;
      color: #fff;
      border-color: #f00;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .action-btn {
      background-color: #000;
      color: #fff;
      border: 3px solid #fff;
      padding: 12px 25px;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.1s;
    }

    .action-btn:hover:not(:disabled) {
      background-color: #ff8c00;
      color: #000;
      border-color: #ff8c00;
    }

    #enemy-sprite {
      position: absolute;
      top: 12%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 100px;
      text-align: center;
      z-index: 50;
      display: none;
    }

    #enemy-sprite.active {
      display: block;
    }

    .dialogue-box {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #000;
      border: 6px solid #fff;
      padding: 25px;
      width: 90%;
      max-width: 800px;
      min-height: 280px;
      display: none;
      z-index: 150;
    }

    /* Speaker label shown above the dialogue text to indicate who is speaking */
    .speaker-label {
      font-size: 11px;
      color: #000;
      background: #ff8c00;
      display: inline-block;
      padding: 6px 10px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-weight: bold;
      letter-spacing: 1px;
    }

    /* Speaker-specific styles applied to the dialogue-box for visual separation */
    .dialogue-box.judge { border-color: #4169e1; }
    .dialogue-box.prosecutor { border-color: #0f0; }
    .dialogue-box.defense { border-color: #f00; }

    .dialogue-box.active {
      display: block;
    }

    @media (max-width: 768px) {
      .dialogue-box {
        width: 95%;
        padding: 15px;
        bottom: 180px;
      }
    }

    .dialogue-text {
      color: #fff;
      font-size: 14px;
      line-height: 1.8;
      min-height: 150px;
    }

    @media (max-width: 768px) {
      .dialogue-text {
        font-size: 11px;
      }
    }

    .dialogue-prompt {
      color: #ff8c00;
      font-size: 9px;
      margin-top: 15px;
      text-align: right;
    }

    .end-screen {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      background-color: #000;
      border: 6px solid #fff;
      padding: 40px;
      display: none;
      z-index: 200;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .end-screen.active {
      display: block;
    }

    .end-screen h2 {
      font-size: 18px;
      margin-bottom: 20px;
      color: #fff;
    }

    .end-screen p {
      font-size: 11px;
      line-height: 1.8;
      margin-bottom: 20px;
      color: #fff;
    }

    .restart-btn {
      background-color: #000;
      color: #ff8c00;
      border: 4px solid #ff8c00;
      padding: 15px 30px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.1s;
      font-weight: bold;
    }

    .restart-btn:hover {
      background-color: #ffa500;
      border-color: #ffa500;
      color: #000;
    }

    #inventory-content {
      text-align: left;
      margin: 20px 0;
    }

    .inventory-item {
      background-color: #111;
      border: 2px solid #ff8c00;
      padding: 15px;
      margin-bottom: 15px;
    }

    .inventory-item-title {
      color: #ff8c00;
      font-size: 10px;
      margin-bottom: 8px;
    }

    .inventory-item-subtitle {
      color: #ffff00;
      font-size: 8px;
      margin-bottom: 8px;
      font-style: italic;
    }

    .inventory-item-content {
      color: #fff;
      font-size: 9px;
      line-height: 1.6;
    }

    .empty-inventory {
      color: #666;
      font-size: 10px;
      text-align: center;
      padding: 30px;
    }

    .scene-background {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
      opacity: 0;
    }

    .scene-library {
      background: linear-gradient(to bottom, #1a0a00 0%, #4a2600 50%, #1a0a00 100%);
    }

    .scene-courtroom {
      background: linear-gradient(to bottom, #0a0a1a 0%, #1a1a4a 50%, #0a0a1a 100%);
    }

    .scene-background::before {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      background-size: 100px 100px;
      opacity: 0.1;
    }

    .scene-library::before {
      background-image: repeating-linear-gradient(0deg, transparent, transparent 35px, #8b4513 35px, #8b4513 36px), repeating-linear-gradient(90deg, transparent, transparent 35px, #8b4513 35px, #8b4513 36px);
    }

    .scene-courtroom::before {
      background-image: repeating-linear-gradient(0deg, transparent, transparent 50px, #4169e1 50px, #4169e1 51px);
    }

    .scene-decoration {
      position: absolute;
      font-size: 60px;
      opacity: 0.2;
      pointer-events: none;
    }

    .hidden {
      display: none !important;
    }

    .transition-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      opacity: 0;
      pointer-events: none;
      z-index: 999;
    }

    .rank-display {
      color: #ff8c00;
      font-size: 16px;
      margin: 15px 0;
      font-weight: bold;
      text-shadow: 2px 2px #000;
    }
  </style>
</head>

<body>
  <div id="game-container">
    <div class="scene-background scene-library hidden" id="library-scene">
      <div class="scene-decoration" style="top: 10%; left: 10%;">üìö</div>
      <div class="scene-decoration" style="top: 15%; right: 15%;">üìñ</div>
      <div class="scene-decoration" style="bottom: 20%; left: 20%;">üìú</div>
      <div class="scene-decoration" style="bottom: 15%; right: 10%;">üèõÔ∏è</div>
    </div>
    <div class="scene-background scene-courtroom hidden" id="courtroom-scene">
      <div class="scene-decoration" style="top: 10%; left: 50%; transform: translateX(-50%);">‚öñÔ∏è</div>
      <div class="scene-decoration" style="top: 20%; left: 15%;">üèõÔ∏è</div>
      <div class="scene-decoration" style="top: 20%; right: 15%;">üèõÔ∏è</div>
      <div class="scene-decoration" style="bottom: 20%; left: 20%;">üìã</div>
      <div class="scene-decoration" style="bottom: 20%; right: 20%;">‚öñÔ∏è</div>
    </div>
    <div class="transition-overlay" id="transition-overlay"></div>
    <canvas id="game-canvas"></canvas>
    <div class="ui-overlay">
      <div class="name-input-screen" id="name-screen">
        <div class="name-input-box">
          <h2>Name the Attorney.</h2>
          <div class="name-display" id="name-display"></div>
          <div class="keyboard-container" id="keyboard"></div>
          <div class="name-controls">
            <button class="name-control-btn" id="backspace-btn">Backspace</button>
            <button class="name-control-btn" id="quit-btn">Quit</button>
            <button class="name-control-btn" id="done-btn">Done</button>
          </div>
        </div>
      </div>

      <div class="tips-selection-screen" id="tips-screen">
        <div class="tips-selection-container">
          <div class="tips-header">
            <h2>LEGAL RESOURCES LIBRARY</h2>
            <p>* Click on any resource to collect it for your investigation.<br>* These will be stored in your inventory
              for reference during the trial.</p>
          </div>

          <div class="tip-category">VOCABULARY BOOK</div>
          <div class="tips-grid" id="vocabulary-grid"></div>

          <div class="tip-category">LEGAL SCROLL</div>
          <div class="tips-grid" id="legal-grid"></div>

          <div class="tips-actions">
            <button class="tips-action-btn" id="skip-tips-btn">Skip All</button>
            <button class="tips-action-btn primary" id="proceed-btn">Proceed to Trial (<span
                id="collected-count">0</span> collected)</button>
          </div>
        </div>
      </div>

      <div class="score-display">SCORE: <span id="score">0</span></div>
      <button class="audio-control" id="audio-toggle">SOUND: ON</button>
      <div class="controls-hint">ARROW KEYS: Move<br>Z/ENTER: Interact</div>

      <div class="mobile-controls" id="mobile-controls">
        <div class="mobile-dpad">
          <button class="mobile-btn up" id="mobile-up">‚ñ≤</button>
          <button class="mobile-btn down" id="mobile-down">‚ñº</button>
          <button class="mobile-btn left" id="mobile-left">‚óÄ</button>
          <button class="mobile-btn right" id="mobile-right">‚ñ∂</button>
        </div>
        <button class="mobile-action" id="mobile-action">Z</button>
      </div>

      <div id="enemy-sprite">‚öñÔ∏è</div>

      <div class="dialogue-box" id="dialogue-box">
        <div class="speaker-label" id="speaker-label" style="display:none"></div>
        <div class="dialogue-text" id="dialogue-text"></div>
        <div class="dialogue-prompt">Press Z or ENTER to continue...</div>
      </div>

      <div class="dialogue-box" id="tips-choice-box">
        <div class="dialogue-text" id="tips-choice-text">* What would you like to learn about?</div>
        <div class="answer-buttons" style="margin-top: 20px;" id="tips-menu">
          <button class="answer-btn" id="vocab-btn">‚òÖ Gender-based Harassment</button>
          <button class="answer-btn" id="legal1-btn">‚òÖ Anti-Photo/Voyeurism Act</button>
          <button class="answer-btn" id="legal2-btn">‚òÖ Safe Spaces Act</button>
          <button class="answer-btn" id="ready-btn" style="grid-column: 1 / -1; border-color: #0f0; color: #0f0;">‚òÖ I'm
            Ready for the Trial</button>
        </div>
      </div>

      <div id="battle-box">
        <div class="stats-bar">
          <span id="player-name">ATTORNEY</span>
          <span>LV <span id="level">1</span></span>
          <div class="hp-bar-container">
            <span>CRED</span>
            <div class="hp-bar-outer">
              <div class="hp-bar-inner" id="hp-bar"></div>
            </div>
            <span><span id="current-hp">20</span> / <span id="max-hp">20</span></span>
          </div>
        </div>
        <div class="question-text" id="question-text"></div>
        <div class="answer-buttons" id="answer-buttons"></div>
        <div class="action-buttons">
          <button class="action-btn" id="act-btn">‚òÖ ACT</button>
          <button class="action-btn" id="item-btn">‚òÖ INVENTORY</button>
          <button class="action-btn" id="mercy-btn">‚òÖ MERCY</button>
        </div>
      </div>

      <div class="end-screen" id="inventory-modal">
        <h2>üìö YOUR COLLECTED RESOURCES</h2>
        <div id="inventory-content"></div>
        <button class="restart-btn" id="close-inventory-btn">Close</button>
      </div>

      <div class="end-screen" id="victory-screen">
        <h2>‚òÖ CASE WON! ‚òÖ</h2>
        <p>You've successfully gathered all evidence and won the case!</p>
        <p>Final Score: <span id="final-score-victory">0</span></p>
        <button class="restart-btn" id="restart-victory">Play Again</button>
      </div>

      <div class="end-screen" id="gameover-screen">
        <h2>CASE DISMISSED</h2>
        <p>The case was dismissed due to insufficient evidence...</p>
        <p>Final Score: <span id="final-score-gameover">0</span></p>
        <button class="restart-btn" id="restart-gameover">Try Again</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script>
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;

    let soundEnabled = true;
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();

    const bgMusic = new Audio();
    bgMusic.loop = true;
    bgMusic.volume = 0.3;
    bgMusic.src = 'YOUR_MUSIC_URL_HERE.mp3';

    function playBackgroundMusic() {
      if (soundEnabled && bgMusic.src) {
        bgMusic.play().catch(e => console.log('Music play failed:', e));
      }
    }

    function stopBackgroundMusic() {
      bgMusic.pause();
      bgMusic.currentTime = 0;
    }

    function playBeep(freq = 440, dur = 0.1, type = 'square') {
      if (!soundEnabled) return;
      const osc = audioContext.createOscillator(), gain = audioContext.createGain();
      osc.connect(gain); gain.connect(audioContext.destination);
      osc.frequency.value = freq; osc.type = type;
      gain.gain.setValueAtTime(0.3, audioContext.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + dur);
      osc.start(audioContext.currentTime); osc.stop(audioContext.currentTime + dur);
    }

    const sounds = {
      menuMove: () => playBeep(300, 0.05),
      menuSelect: () => playBeep(600, 0.1),
      textBlip: () => playBeep(200, 0.03),
      collect: () => { playBeep(523, 0.1); setTimeout(() => playBeep(659, 0.15), 100); },
      correct: () => { playBeep(523, 0.1); setTimeout(() => playBeep(659, 0.1), 100); setTimeout(() => playBeep(784, 0.2), 200); },
      wrong: () => playBeep(200, 0.3, 'sawtooth'),
      victory: () => { playBeep(523, 0.15); setTimeout(() => playBeep(659, 0.15), 150); setTimeout(() => playBeep(784, 0.15), 300); setTimeout(() => playBeep(1047, 0.3), 450); }
    };

    document.getElementById('audio-toggle').onclick = () => {
      soundEnabled = !soundEnabled;
      document.getElementById('audio-toggle').textContent = soundEnabled ? 'SOUND: ON' : 'SOUND: OFF';
      if (soundEnabled) {
        sounds.menuSelect();
        playBackgroundMusic();
      } else {
        stopBackgroundMusic();
      }
    };

    const mobileKeys = { up: false, down: false, left: false, right: false };
    if (isMobile) {
      document.getElementById('mobile-controls').style.display = 'flex';
      ['up', 'down', 'left', 'right'].forEach(dir => {
        const btn = document.getElementById(`mobile-${dir}`);
        btn.addEventListener('touchstart', (e) => { e.preventDefault(); mobileKeys[dir] = true; });
        btn.addEventListener('touchend', (e) => { e.preventDefault(); mobileKeys[dir] = false; });
      });
      document.getElementById('mobile-action').addEventListener('touchstart', (e) => {
        e.preventDefault(); sounds.menuSelect();
        if (gameMode === 'walking' && canInteract) startDialogue();
        else if (gameMode === 'dialogue' && !isTyping) showNextDialogue();
        else if (gameMode === 'dialogue' && isTyping) { isTyping = false; document.getElementById('dialogue-text').textContent = targetText; }
      });
    }

    let gameMode = 'nameEntry', playerName = '', currentName = '';
    const MAX_NAME_LENGTH = 7;
    let score = 0, maxHP = 20, currentHP = 20, currentQuestionIndex = 0, dialogueIndex = 0, canInteract = false, answeringQuestion = false;
    const player = { x: canvas.width / 2, y: canvas.height / 2, size: 20, speed: 4, color: '#ff0000' };
    const npc = { x: canvas.width / 2, y: 180, size: 40, color: '#ffff00' };
    const keys = {};

    const availableTips = {};
    let collectedTips = [];

    const narratorDialogues = [
      () => `* Welcome Attorney ${playerName}! As you may know, you have been called here to solve a particular case in which a public figure "X" and some authorities have been caught engaging in online-based violence.`,
      "* A female lawyer was the one who filed the case. According to her, she was preparing to travel when someone captured a photo under her skirt without her consent.",
      "* To gather all of the evidence that you need in your investigation, you must answer all of the questions correctly.",
      "* This evidence is important for building a strong case in court to win. Choose your answer wisely.",
      "* The courtroom awaits. It's not just a case; it's a fight for dignity, respect, and justice in the face of online gender-based violence."
    ];

    const npcTipsDialogues = [
      "* Since it's your first time attending a court hearing, here are some tips that you could use.",
      "* Don't worry, though; it could also be viewed later whenever you need a short refresher about it.",
      "* What would you like to learn about?"
    ];

    const tipsInfo = {
      vocab1: {
        title: "Gender-based Harassment",
        dialogue: "* Gender-based Harassment is a kind of harassment wherein someone is treated badly because of their gender. This is an important concept to understand for this case."
      },
      legal1: {
        title: "Section 4(a) of Republic Act 9995",
        subtitle: "Anti-Photo or Voyeurism Act of 2009",
        dialogue: "* Section 4(a) of Republic Act 9995, also known as the Anti-Photo or Voyeurism Act of 2009, is about taking photos or videos of a person performing sexual acts or their private areas without consent. This is very relevant to our case."
      },
      legal2: {
        title: "Section 4 of RA 11311",
        subtitle: "Safe Spaces Act",
        dialogue: "* Section 4 of RA 11311, the Safe Spaces Act, is about gender-based sexual harassment in public spaces. This aims to protect the citizens from sexual harassment in public spaces."
      }
    };

    let dialogues = [];
    let currentDialoguePhase = 'narrator';

    const questions = [
      {// QUESTION 1
        preDialogues: [
          "JUDGE: Prosecution, before we hear your witness testimony, please establish the primary legal framework for this case.",
          "JUDGE: Under which Republic Act are you primarily prosecuting the defendant of  online harassment charges?"
        ],
        text: "Under which Republic Act and specific section are you prosecuting the gender-based online sexual harassment charges against Ms. Patricia Santos?",
        answers: [
          "Republic Act No. 10175 Section 4(c)(4) - Cyber Libel",
          "Republic Act No. 11313 Section 4 - Gender-based Online Sexual Harassment",
          "Republic Act No. 9995 Section 4(a) - Photo and Video Voyeurism",
          "Republic Act No. 7877 - Anti-Sexual Harassment Act"
        ],
        correct: 1,
        correctMsg: "‚òÖ YOU (PROSECUTOR): Your Honor! The prosecution is proceeding under Republic Act No. 11313, Section 4‚ÄîGender-based Online Sexual Harassment! It  covers unwelcome sexual comments, intimidation, also graphic material shared via social media such as Messenger, Instagram, or Facebook!\n\n‚òÖ YOU (PROSECUTOR): Both Chat Log Transcript Alpha and  Chat Log Transcript Beta showcase unwelcome, repeated sexual harassment directed at Maria via social platforms. The Safe Spaces Act exists expressly to fight this kind of online abuse targeting someone because of their gender! \n\n‚òÖ JUDGE: I see your point councilor, Its reasonable to say that Section 4 of RA11313 is indeed the primary charge.\n\n‚òÖ DEFENSE ATTORNEY: *grimaces* The prosecution knows their doing...\n\n‚òÖ Credibility Score: +5",
        wrongMsgs: [
          "‚úó YOU (PROSECUTOR): Your Honor, we're prosecuting under RA 10175, Section 4‚ÄîCyber Libel...\n\n‚úó DEFENSE ATTORNEY: OBJECTION! The prosecution misidentifies the primary charge! While RA 10175's cyber libel may apply to defamatory posts, the MAIN charges concern persistent sexual harassment through WhatsApp and Instagram with Chat Log Transcript Alpha and Chat Log Transcript Beta!\n\n‚úó DEFENSE ATTORNEY: Those fall under RA 11313 Section 4, Gender-based Online Sexual Harassment! The prosecutor should know which law they're primarily using!\n\n‚úó DEFENSE ATTORNEY: Your Honor, this shows fundamental confusion about the case structure!\n\n‚úó JUDGE: Sustained. Prosecution, RA 11313 Section 4 governs the primary harassment charges. Cyber libel may be an additional count, but clarify your primary legal basis.",
          "‚úó YOU (PROSECUTOR): Your Honor, we're prosecuting under RA 9995 Section 4(a)‚ÄîPhoto and Video Voyeurism...\n\n‚úó DEFENSE ATTORNEY: HOLD IT! The prosecution is focusing on separate incidents! \n\n‚úó DEFENSE ATTORNEY: Yes, RA 9995 applies to the CCTV Footage of NAIA Terminal 3  and the unauthorized picture. But the primary charges involve six months of online sexual harassment through messaging platforms! \n\n‚úó DEFENSE ATTORNEY: That's RA 11313 Section 4! Chat Log Transcript Alpha and Chat Log Transcript Beta aren't photos that are under RA995 they're sexually explicit messages and persistent unwanted advances! The prosecutor seems confused about which law governs which conduct!\n\n‚úó JUDGE: Sustained. Prosecution, distinguish between the voyeurism incident and the online harassment charges. RA 11313 Section 4 governs digital harassment.",
          "‚úó YOU (PROSECUTOR): Got it,Your Honor, we're prosecuting under RA 7877‚Äîthe Anti-Sexual Harassment Act..\n\n‚úó DEFENSE ATTORNEY: OBJECTION! The prosecution cites an outdated law! RA 7877 from 1995 addresses workplace and educational sexual harassment, primarily physical conduct.\n\n‚úó DEFENSE ATTORNEY: This was established way before anyone was posting online. The modern law for ONLINE gender-based harassment is RA 11313 Section 4, the Safe Spaces Act of 2019! \n\n‚úó DEFENSE ATTORNEY: Chat Log Transcript Alpha and Chat Log Transcript Beta show Messenger and Instagram harassment‚Äîdigital platforms that didn't exist when RA 7877 was written! The prosecutor should use the correct, applicable statute!\n\n‚úó JUDGE: Sustained. RA 7877 establishes CODI requirements, but RA 11313 Section 4 specifically governs online harassment. Update your legal framework, Counselor."
        ]
      },
      { // QUESTION 2
      preDialogues: [
          "JUDGE: Prosecution, you've presented,CCTV Footage of NAIA Terminal 3 showing the defendant photographing under a woman's skirt.",
          "JUDGE: Under which specific provision are you charging this conduct?"
        ],
        text: "The  CCTV Footage of NAIA Terminal 3  shows CCTV footage of the defendant taking an upskirt photograph at NAIA. Under which specific section of RA 9995 is this conduct prohibited?",
        answers: [
          "Section 4(a) - Taking photos under a person's clothing without consent",
          "Section 3(a) - Photo voyeurism in private places",
          "Section 5 - Penalties for distribution of voyeuristic materials",
          "Section 6 - Venue and jurisdiction provisions"
        ],
        correct: 0,
        correctMsg: "‚òÖ YOU (PROSECUTOR): Your Honor!  Section 4(a) of the Anti-Photo and Video Voyeurism Act explicitly prohibits taking photos or videos under a person's clothing without consent!\n\n‚òÖ YOU (PROSECUTOR): CCTV Footage of NAIA Terminal 3 's CCTV footage shows the defendant positioning his phone at an upward angle beneath the victim‚Äôs skirt at 2:15 PM. \n\n‚òÖ YOU (PROSECUTOR): And the photo itself proves it ‚Äì its data matches the time of the incident exactly. Moreover, a similar prosecution happened right here, involving a Cebu City official, establishing this behavior breaks the law as outlined in Section 4‚Äî\n\n‚òÖ JUDGE: That‚Äôs spot on, Counsel, Section 4(a) is the applicable provision.\n\n‚òÖ DEFENSE ATTORNEY: *shuffles papers nervously* The evidence is... concerning..\n\n‚òÖ Credibility Score: +5",
        wrongMsgs: [
          "‚úó YOU (PROSECUTOR): Your Honor, this violates Section 3(a) regarding voyeurism in private places...\n\n‚úó DEFENSE ATTORNEY SANTIAGO: OBJECTION! That application of the law is way off. Section 3(a) specifically concerns itself with peeping into PRIVATE spaces like bathrooms or bedrooms.\n\n‚úó DEFENSE ATTORNEY SANTIAGO: But NAIA Terminal 3 is a PUBLIC airport! More importantly, the prosecutor misses the point. A more applicable law would be section 4(a) specifically prohibits photographing UNDER someone's CLOTHING, regardless of location!\n\n‚úó DEFENSE ATTORNEY SANTIAGO: Whether in a private location  or public airport,taking photos up someone‚Äôs skirt violates Section 4(a). The location doesn't determine the violation; the act of photographing under clothing does!\n\n‚úó JUDGE: Sustained. Section 4(a) governs upskirt photography regardless of public or private setting.",
          "‚úó YOU (PROSECUTOR): Your Honor, Section 5 on distribution penalties applies...\n\n‚úó DEFENSE ATTORNEY SANTIAGO: HOLD IT ! The prosecution charges distribution without proof the defendant did the offense!\n\n ‚úó DEFENSE ATTORNEY SANTIAGO:  the prosecution must first prove the photo was illegally OBTAINED under Section 4(a)! Digital Forensics Report shows the photo was found on my client's phone, but there's no evidence of distribution!\n\n‚úó DEFENSE ATTORNEY SANTIAGO: The prosecutor is charging the wrong section‚ÄîTheyre focusing on the charge of distributing the photo not TAKING it!\n\n‚úó JUDGE: Sustained. Establish the violation of Section 4(a)  for taking the photo first, Prosecution.",
          "‚úó YOU (PROSECUTOR): Your Honor, Section 6 regarding venue and jurisdiction...\n\n‚úó DEFENSE ATTORNEY SANTIAGO: OBJECTION! The prosecution is talking about paperwork, not guilt or innocence! Section 6 simply dictates where to bring a case; it doesn‚Äôt define the crime itself!\n\n‚úó DEFENSE ATTORNEY SANTIAGO:  CCTV Footage of NAIA Terminal 3  allegedly shows my client photographing under someone's clothing. That conduct, if proven, would violate Section 4(a)!\n\n‚úó DEFENSE ATTORNEY SANTIAGO: Venue provisions set where a trial happens - not what someone did. The prosecutor confuses procedure with content!\n\n‚úó JUDGE: Sustained. Section 6 is about the venue, not the criminal prohibition itself. Section 4(a) defines the offense."
        ]
      },
      { // QUESTION 3
      preDialogues: [
          "YOU (PROSECUTOR): Your Honor, I call the defendant‚Äôs co-worker and the victim  Ms. Maria to the stand.",
          "(Ms. Maria approach the stand to take an oath)",
          "YOU (PROSECUTOR): So, Ms. Maria‚Ä¶",
          "YOU (PROSECUTOR): Because this person works with you, you first reported it to the company‚Äôs Committee on Decorum and Investigation rather than going straight to the police  is that correct?",
          "MS. MARIA: Yes, I followed the company's procedures first, not to get involved in some serious policy violation, if I disobeyed I might get fired.",
          "MS. MARIA: Which is bad for me since I‚Äôm building a great portfolio.",
          "DEFENSE ATTORNEY SANTIAGO: Your Honor, what relevance does institutional policy have to criminal proceedings?"
        
        ],
        text: "Institutional Policy Document shows the employer's established harassment complaint procedures. Under RA 11313, what are employers and institutions REQUIRED to do regarding gender-based harassment?",
      
        answers: [
          "Simply post the law on bulletin boards",
          "Terminate accused employees upon any complaint",
          "Immediately report all complaints to police",
          "Establish policies,training and implement mechanisms like CODI to address complaints"
        ],
        correct: 3,
        correctMsg: "‚òÖ YOU (PROSECUTOR): Your Honor! presents Institutional Policy Document  RA 11313 doesn't just prohibit harassment‚Äîit REQUIRES institutional accountability\n\n‚òÖ YOU (PROSECUTOR): Employers and educational institutions must establish comprehensive policies, provide training to staff about gender-based harassment,\n\n‚òÖ YOU (PROSECUTOR): AND implement mechanisms like the Committee on Decorum and Investigation to receive and address complaints!\n\n‚òÖ YOU (PROSECUTOR): The Institutional Policy Document  shows the companies  followed the proper procedure  regarding Ms. Maria‚Äôs case.\n\n‚òÖ YOU (PROSECUTOR): Consequently, this indicates the situation wasn‚Äôt just a minor issue it needed looking into by authorities alongside the company itself.\n\n‚òÖ YOU (PROSECUTOR): The reference materials confirm institutions must create these systematic response mechanisms!\n\n‚òÖ JUDGE: Excellent explanation, Counselor. Institutional compliance strengthens your case.\n\n‚òÖ MS. MARIA: The company took it seriously, and so should this court.\n\n‚òÖ JUDGE: That is correct, let the eyes of everyone here be clear and our ears be none stopped\n\n‚òÖ Credibility Score: +5",
        wrongMsgs: [
          "‚úó YOU (PROSECUTOR): Your Honor, institutions just need to post the law on bulletin boards...\n\n‚úó DEFENSE ATTORNEY SANTIAGO: OBJECTION! The prosecution is making light of what organizations are supposed to do.\n\n‚úó DEFENSE ATTORNEY SANTIAGO: It isn‚Äôt enough to simply display notices, RA 11313 demands they actually do something.\n\n‚úó DEFENSE ATTORNEY SANTIAGO: Employers must establish policies, conduct training, and implement functional complaint mechanisms like CODI!\n\n‚úó DEFENSE ATTORNEY SANTIAGO: The Institutional Policy Document  shows Ms. Maria's employer created comprehensive procedures, not decorative wall displays!\n\n‚úó DEFENSE ATTORNEY SANTIAGO: If the prosecutor thinks posting a note satisfies institutional duties, they fundamentally misunderstand RA 11313's requirements!\n\n‚úó DEFENSE ATTORNEY SANTIAGO: Their grasp of the relevant laws seemed questionable.\n\n ‚úó JUDGE: Sustained. Institutions must implement active systems, not passive displays. Study the statute more carefully, Prosecution.",
          "‚úó YOU (PROSECUTOR): Your Honor, employers must terminate the accused employee immediately...\n\n‚úó DEFENSE ATTORNEY SANTIAGO: OBJECTION! The prosecution proposes violations of due process! Firing someon  based solely on accusations violates constitutional rights!\n\n‚úó DEFENSE ATTORNEY SANTIAGO: RA 11313 requires institutions to INVESTIGATE through mechanisms like CODI to collect proof, listin to everyone involved, make conclusions, THEN apply appropriate penalties which MIGHT include termination!\n\n‚úó DEFENSE ATTORNEY SANTIAGO: Institutional Policy Document shows proper procedure with investigation before action. The prosecutor's statement  would eliminate due process entirely!\n\n‚úó JUDGE: Sustained. Due process requires investigation before sanction. Reconsider your understanding of institutional procedures, Counselor.",
          "‚úó YOU (PROSECUTOR): Your Honor, employers must immediately report all incidents to police...\n\n‚úó DEFENSE ATTORNEY SANTIAGO: HOLD IT! The prosecution doesn't even know mandatory requirements!\n\n‚úó DEFENSE ATTORNEY SANTIAGO: RA 11313 requires institutions to establish internal investigation mechanisms like CODI to receive and investigate complaints.\n\n‚úó DEFENSE ATTORNEY SANTIAGO: Victims choose whether to pursue criminal charges separately! The Institutional Policy Document  shows proper procedure.\n\n‚úó DEFENSE ATTORNEY SANTIAGO: Ms. Maria filed with CODI, they investigated, then SHE decided to file criminal charges.\n\n‚úó DEFENSE ATTORNEY SANTIAGO: Not all harassment complaints warrant police involvement some require company action only. The prosecutor misunderstands what's the difference between institutional vs. criminal processes!\n\n‚úó JUDGE: Sustained. Institutions investigate internally; victims decide whether to pursue criminal charges separately."
        ]
      },
      { // QUESTION 4: to be accomplished 
      preDialogues: [
          "JUDGE: Prosecution, you've presented,CCTV Footage of NAIA Terminal 3 showing the defendant photographing under a woman's skirt.",
          "JUDGE: Under which specific provision are you charging this conduct?"
        ],
        text: "The  CCTV Footage of NAIA Terminal 3  shows CCTV footage of the defendant taking an upskirt photograph at NAIA. Under which specific section of RA 9995 is this conduct prohibited?",
        answers: [
          "Section 4(a) - Taking photos under a person's clothing without consent",
          "Section 3(a) - Photo voyeurism in private places",
          "Section 5 - Penalties for distribution of voyeuristic materials",
          "Section 6 - Venue and jurisdiction provisions"
        ],
        correct: 0,
        correctMsg: "‚òÖ YOU (PROSECUTOR): Your Honor!  Section 4(a) of the Anti-Photo and Video Voyeurism Act explicitly prohibits taking photos or videos under a person's clothing without consent!\n\n‚òÖ YOU (PROSECUTOR): CCTV Footage of NAIA Terminal 3 's CCTV footage shows the defendant positioning his phone at an upward angle beneath the victim‚Äôs skirt at 2:15 PM. \n\n‚òÖ YOU (PROSECUTOR): And the photo itself proves it ‚Äì its data matches the time of the incident exactly. Moreover, a similar prosecution happened right here, involving a Cebu City official, establishing this behavior breaks the law as outlined in Section 4‚Äî\n\n‚òÖ JUDGE: That‚Äôs spot on, Counsel, Section 4(a) is the applicable provision.\n\n‚òÖ DEFENSE ATTORNEY: *shuffles papers nervously* The evidence is... concerning..\n\n‚òÖ Credibility Score: +5",
        wrongMsgs: [
          "‚úó YOU (PROSECUTOR): Your Honor, this violates Section 3(a) regarding voyeurism in private places...\n\n",
          "‚úó YOU (PROSECUTOR): Your Honor, Section 5 on distribution penalties applies...\n\n",
          "‚úó YOU (PROSECUTOR): Your Honor, Section 6 regarding venue and jurisdiction...\n\n"
        ]
      },

      { // QUESTION 5
      preDialogues: [
          "YOU (PROSECUTOR): Your Honor, Chat Log Transcript Beta reveals a disturbing pattern‚Äî47 Instagram messages over 21 days.",
          "(The screen shows messages including: \"You're so sexy in your stories,\" \"I deserve a chance,\" \"Don't be cold to me\")",
          "YOU (PROSECUTOR): Ms. Maria, did you respond to these messages?",
          "MS. MARIA: On March 23, I clearly told her: \"Please stop contacting me.\" But he kept sending messages for 18 more days even  after I asked him to stop."
          "DEFENSE ATTORNEY SANTIAGO: Your Honor, my client was merely expressing romantic interest!",
          "JUDGE: Prosecution, address the defense's claim."
        ],
        text: "Chat Log Transcript Beta shows 47 messages sent over 21 days, with 34 messages sent AFTER the victim explicitly said \"Please stop contacting me\" on March 23. What does this pattern establish under RA 11313?",
        answers: [
          "Mutual romantic interest requiring no legal intervention",
          "Persistent and systematic gender-based online harassment showing deliberate disregard for boundaries",
          "Protected freedom of expression under the Constitution",
          "Simple miscommunication that doesn't constitute harassment"
        ],
        correct: 0,
        correctMsg: "‚òÖ YOU (PROSECUTOR): Your Honor! *slams desk* This is NOT romance‚Äîthis is SYSTEMATIC HARASSMENT!\n\n‚òÖ YOU (PROSECUTOR): Chat Log Transcript Beta shows the victim stated 'Please stop contacting me' on March 23, a clear, unambiguous rejection! Yet the defendant sent 34 MORE messages over 18 days!\n\n‚òÖ YOU (PROSECUTOR): Section 4 of RA 11313 makes it clear this behavior is forbidden: persistent unwanted sexual advances that deliberately violate the victims boundaries!\n\n‚òÖ YOU (PROSECUTOR): the psychological report, confirms Ms. Maria developed anxiety and sleep disturbances from this constant barrage! This is textbook gender-based online harassment!\n\n‚òÖ JUDGE: Powerfully argued, Counselor. The pattern demonstrates systematic violation of boundaries.\n\n‚òÖ MS. MARIA: *emotionally* he wouldn't stop, no matter what I said.\n\n‚òÖ DEFENSE ATTORNEY SANTIAGO: *sits down quietly*\n\n‚òÖ Credibility Score: +5",
        wrongMsgs: [
          "‚úó YOU (PROSECUTOR): Your Honor, this could be interpreted as mutual romantic interest...\n\n‚úó DEFENSE ATTORNEY SANTIAGO: Your Honor, even the PROSECUTION admits this appears mutual! If the prosecutor themselves sees romantic interest rather than harassment, how can they prove criminal charges?\n\n‚úó DEFENSE ATTORNEY SANTIAGO: This admission destroys their own case! Chat Log Transcript Beta clearly shows my client's messages were unwanted, but the prosecutor just characterized them as mutual!\n\n‚úó DEFENSE ATTORNEY SANTIAGO: The prosecutor doesn't believe in their own charges!\n\n‚úó JUDGE: Prosecution, you're arguing against your own case! Chat Log Transcript Beta shows explicit rejection followed by persistent contact.\n\n‚úó JUDGE: That's harassment, not mutual interest. Reconsider your position immediately.\n\n‚úó Ms. Maria: *looks betrayed* I said \"please stop\"... how is that mutual?",
          "‚úó YOU (PROSECUTOR): Your Honor, these messages might be protected freedom of expression...\n\n‚úó DEFENSE ATTORNEY SANTIAGO: Your Honor, the PROSECUTION is making my argument for me! \n\n‚úó DEFENSE ATTORNEY SANTIAGO: If the prosecutor believes these messages are constitutionally protected speech, why are they prosecuting my client? \n\n ‚úó DEFENSE ATTORNEY SANTIAGO: This is preposterous ‚Äîthe prosecutor admits the conduct they're charging is legally protected! \n\n‚úó DEFENSE ATTORNEY SANTIAGO: Either they're clueless about constitutional law, or they're bringing charges they know are meritless! This seriously damages their credibility!\n\n‚úó JUDGE: Prosecution! Are you defending or prosecuting? Freedom of expression doesn't protect harassment after explicit rejection. \n\n‚úó JUDGE: 34 messages following \"please stop\" is not protected speech‚Äîit's criminal conduct under RA 11313!\n\n‚úó MS. MARIA: confused Whose side are you on?",
          "‚úó YOU (PROSECUTOR): Your Honor, this seems like miscommunication...\n\n‚úó DEFENSE ATTORNEY SANTIAGO: Your Honor, the PROSECUTION calls their own case a \"miscommunication\"! If the prosecutor doesn't believe this is criminal harassment, why are we in court? \n\n‚úó DEFENSE ATTORNEY SANTIAGO: They're essentially agreeing with the defense! \‚ÄùPlease stop contacting me\‚Äù followed by 34 ignored messages isn't miscommunication‚Äîbut the prosecutor just said it is! \n\n‚úó DEFENSE ATTORNEY SANTIAGO: This prosecutor either doesn't understand their own case or doesn't believe in it!\n\n‚úó JUDGE: Prosecution, you're sabotaging your own case! \"Please stop contacting me\" is crystal clear‚Äînot a miscommunication! \n\n‚úó JUDGE: 34 subsequent messages demonstrate deliberate harassment. If you don't believe in your own charges, dismiss them!\n\n‚úó Ms. Maria: *standing* What was unclear about \"please stop\"?!"
        ]
      },

      { // QUESTION 6
      preDialogues: [
          "YOU (PROSECUTOR): Your Honor, I now present a Screenshot of a Public Facebook Post from May 2, 2025.",
          "(The screen displays: \"Maria is secretly gay but pretends to be straight to get women. I have proof he's been lying to everyone.\")",
          "YOU (PROSECUTOR): This post was shared 847 times, reaching 47,000 people before removal.",
          "DEFENSE ATTORNEY SANTIAGO: Objection! What does this have to do with harassment? This is simply my client expressing an opinion!",
          "JUDGE: Prosecution, explain what additional legal violation this post constitutes beyond the harassment charges."
        ],
        text: "Screenshot of Public Facebook Post contains false statements about the victim's sexual orientation posted publicly with apparent defamatory intent, reaching 47,000 people. What additional violation does this constitute?",
        answers: [
          "Copyright infringement under RA 8293",
          "Data Privacy violations under RA 10173",
          "Cyber libel under Section 4of RA 10175 (Cybercrime Prevention Act)",
          "Consumer fraud under RA 7394"
        ],
        correct: 2,
        correctMsg: "‚òÖ YOU (PROSECUTOR): Your Honor! *presents evidence forcefully* This transcends harassment‚Äîit's CYBER LIBEL under Section 4 of RA 10175! \n\n‚òÖ YOU (PROSECUTOR): The defendant made specific FALSE factual claims about Ms. Maria's sexual orientation, stating \‚ÄúI have proof\‚Äù when Digital Forensics Report 's results found NO such proof on his devices! \n\n‚òÖ YOU (PROSECUTOR): He published this defamatory content to 47,000 people through Facebook that's defamation amplified by digital means! The prosecution is charging BOTH RA 11313 harassment AND RA 10175 cyber libel. \n\n‚òÖ JUDGE: That‚Äôs spot on, Counsel, We‚Äôll add cyber libel to the list.\n\n‚òÖ MS.MARIA: tearfully That post destroyed my reputation with everyone I know.\n\n‚òÖ DEFENSE ATTORNEY SANTIAGO: frowns The layering of charges is... legally sound.\n\n‚òÖ Credibility Score: +5",
        wrongMsgs: [
          "‚úó YOU (PROSECUTOR): Your Honor, this violates copyright law under RA 8293...\n\nOBJECTION! The prosecutor confuses defamation with intellectual property! Copyright protects creative works like books, music, and art from unauthorized copying! \n\n‚úó DEFENSE ATTORNEY SANTIAGO:  Screenshot of Public Facebook Post contains FALSE STATEMENTS about my client making defamatory claims about someone's sexual orientation! There's no copyrighted work here! \n\n‚úó DEFENSE ATTORNEY SANTIAGO:  The prosecution muddling copyright with cyber  libel? A glaring sign of incompetence, really - it throws their whole argument into question\n\n‚úó JUDGE: Sustained. Copyright and defamation are entirely different legal areas. If you're charging this post, it would be cyber libel under RA 10175, not copyright infringement. This is a fundamental error, Counselor.\n\n‚úó Ms. Maria: *confused* How is a post about me related to copyright?",
          "‚úó YOU (PROSECUTOR): Your Honor, this violates data privacy under RA 10173...\n\n‚úó DEFENSE ATTORNEY SANTIAGO:  OBJECTION! The prosecutor misunderstands data privacy law! RA 10173 is about  unauthorized COLLECTION, PROCESSING, or DISCLOSURE of personal data by organizations and institutions! \n\n‚úó DEFENSE ATTORNEY SANTIAGO:  The screenshot of the  public Facebook post shows my client making FALSE PUBLIC STATEMENTS, that's defamation, not data privacy violation! \n\n‚úó DEFENSE ATTORNEY SANTIAGO: He didn't hack a database or process collected information,He just posted a lie on Facebook!  \‚ÄúThe prosecution believing this is a breach of data security shows how little they understand the law\‚Äù.\n\n‚úó JUDGE: Sustained. Data privacy law governs data handling by organizations, not false public statements by individuals. \n\n‚úó JUDGE: This is cyber libel under RA 10175, Counselor. Know the difference.",
          "‚úó YOU (PROSECUTOR): Your Honor, this constitutes consumer fraud under RA 7394...\n\n‚úó DEFENSE ATTORNEY SANTIAGO: OBJECTION! The prosecutor is using rules for businesses when this is about someone‚Äôs reputation! \n\n‚úó DEFENSE ATTORNEY SANTIAGO: Consumer protection law addresses fraudulent business practice lille false advertising, defective products, deceptive sales! \n\n‚úó DEFENSE ATTORNEY SANTIAGO:  The screenshot of the public Facebook post shows a Facebook post making false claims about someone's sexual orientation! \n\n‚úó DEFENSE ATTORNEY SANTIAGO: There's no commercial transaction, no product, no consumer relationship!\n\n‚úó DEFENSE ATTORNEY SANTIAGO: If the prosecutor thinks a defamatory social media post is consumer fraud, It shows a startling lack of grasp on law itself ‚Äì frankly, it‚Äôs quite shocking.\n\n‚úó JUDGE: Sustained. Consumer protection law governs commercial transactions, not personal defamation on social media. \n\n‚úó JUDGE: This error suggests serious gaps in your legal knowledge, Prosecution.\n\n‚úó Ms. Maria: frustrated How is what he said about me related to consumer products?"
        ]
      },
      { // QUESTION 7
      preDialogues: [
          "YOU (PROSECUTOR): Your Honor, I present the NBI Cybercrime Division's comprehensive Digital Forensics Report.",
          "(A thick technical document is displayed showing IP addresses, device metadata, EXIF data, and account ownership analysis.)",
          "DEFENSE ATTORNEY SANTIAGO: Your Honor, this is just technical jargon! What does it actually prove?",
          "JUDGE: Prosecution, explain the legal purpose of this forensic evidence in your case."
        ],
        text: "Digital Forensics Report  confirms IP addresses, device metadata, EXIF data, and account ownership linking all harassing content to the defendant. What is the primary legal purpose of this forensic evidence?",
        answers: [
          "To demonstrate the defendant's advanced technical sophistication",
          "To establish identity and attributability‚Äîproving the defendant personally committed the acts",
          "To calculate monetary value of devices for damages",
          " To prove the victim's lack of technical knowledge"
        ],
        correct: 1,
        correctMsg: "‚òÖ YOU (PROSECUTOR): Your Honor! presents report decisively Digital Forensics Report  serves one critical purpose:\n\n‚òÖ YOU (PROSECUTOR): ATTRIBUTION! In cybercrime prosecution, defendants often claim 'someone else used my account' or 'my phone was stolen.' This 47-page forensic analysis eliminates such defenses!\n\n ‚òÖ YOU (PROSECUTOR): The NBI Cybercrime Division confirmed that the Samsung Galaxy S21 registered to Dwg sent Chat Log Transcript Alpha's Messenger messages and that HIS Instagram account sent Chat Log Transcript Beta's DMs,\n\n ‚òÖ YOU (PROSECUTOR): that HIS Facebook account posted the Screenshot of the  Public Facebook Post, and that HIS phone's camera captured the unauthorized picture at the exact time shown in CCTV Footage of NAIA Terminal 3!\n\n ‚òÖ YOU (PROSECUTOR): This evidence proves HE committed these acts!\n\n‚òÖ JUDGE: Excellently articulated, Counselor. Attribution is indeed the foundation of cybercrime prosecution.\n\n‚òÖ MS. MARIA: The forensics prove it was definitely his.\n\n‚òÖ DEFENSE ATTORNEY SANTIAGO: reluctantly nods The attribution evidence is... thorough.\n\n‚òÖ Credibility Score: +5",
        wrongMsgs: [
          "‚úó YOU (PROSECUTOR): Your Honor, this forensic report demonstrates the defendant's technical sophistication...\n\n‚úó DEFENSE ATTORNEY SANTIAGO: OBJECTION! The prosecution misses the entire point of forensic evidence! Technical skill is irrelevant to guilt! \n\n‚úó DEFENSE ATTORNEY SANTIAGO: Whether my client is a computer genius or technologically illiterate doesn't prove if he committed these acts! \n\n‚úó DEFENSE ATTORNEY SANTIAGO: The digital forensics report  exists to prove IDENTITY‚Äîthat HE sent the messages, posted the content and took the photos! \n\n‚úó DEFENSE ATTORNEY SANTIAGO: The prosecutor's focus on being  'skilled ' suggests they don't understand what digital forensics actually accomplish in cybercrime cases! This undermines their credibility! \n\n‚úó JUDGE: Sustained. Forensics establishes who committed the acts, not their technical skill level. Focus on attribution, Counselor. \n\n‚úó Ms. Maria: Whether he's tech-savvy doesn't matter‚Äîdid he do it or not? \n\n",
          "‚úó YOU (PROSECUTOR): Your Honor, the forensics calculate device values for damages...\n\n‚úó DEFENSE ATTORNEY SANTIAGO: OBJECTION! The prosecutor is cataloging gadgets instead of investigating a crime! That report maps what happened, it doesn‚Äôt list costs.\n\n‚úó DEFENSE ATTORNEY SANTIAGO: The report analyzes IP addresses, app data, account ownership to prove my client committed these acts! Device value is irrelevant to criminal prosecution! \n\n‚úó DEFENSE ATTORNEY SANTIAGO: If the prosecutor thinks forensics are about property appraisal rather than criminal attribution, they fundamentally misunderstand digital evidence! A worrying sign of inadequacy, to say the least.\n\n‚úó JUDGE: Sustained. Criminal forensics prove identity and criminal acts, not property values. This is a serious misunderstanding, Prosecution.\n\n",
          "‚úó YOU (PROSECUTOR): Your Honor, this report demonstrates the victim's technological vulnerabilities...\n\n‚úó DEFENSE ATTORNEY SANTIAGO: OBJECTION! The prosecution victim-blames through digital evidence! Digital Forensics Report  analyzes the DEFENDANT'S devices and accounts, not the victim's! \n\n‚úó DEFENSE ATTORNEY SANTIAGO: The forensics examine HIS phone, HIS social media, HIS digital footprint to prove He committed harassment! Ms. Maria's technical knowledge is completely irrelevant! \n\n‚úó DEFENSE ATTORNEY SANTIAGO: Even if he were a cybersecurity expert, harassment would still be criminal! Its concerning that the prosecution is focused on what the victim did - or didn‚Äôt do - rather than holding the accused responsible \n\n‚úó JUDGE: Sustained. Forensics establish defendant's actions, not victim's vulnerabilities. This victim-blaming approach is inappropriate, Counselor. \n\n‚úó MS. MARIA: *angry* Are you seriously blaming ME for his harassment?"
        ]
      },

      { // QUESTION 8
      preDialogues: [
          "YOU (PROSECUTOR): Your Honor, I now present an expert psychological report of the psychological impact assessment.",
          "(The screen displays excerpts: \"Patient presents with symptoms consistent with anxiety disorder directly attributable to sustained online harassment. Sleep disturbances, hypervigilance, workplace performance decline, and social withdrawal documented.\")",
          "DEFENSE ATTORNEY SANTIAGO: Your Honor, these are just emotional complaints! Real harm requires physical injury!",
          "JUDGE: Prosecution, address the defense's argument about psychological harm."
        ],
        text: " Expert Psychological Report documents Ms. Maria's anxiety, sleep disturbances, and workplace decline caused by the harassment. Under RA 11313 and related laws, what role does proof of psychological harm play?",
        answers: [
          "Psychological harm is irrelevant; only physical injury matters",
          "Psychological harm establishes severity and impact, supporting both prosecution and damages",
          "Victims must prove permanent psychological disability for prosecution",
          "Psychological reports are inadmissible hearsay"
        ],
        correct: 1,
        correctMsg: "‚òÖ YOU (PROSECUTOR): Your Honor! *presents report passionately*  this expert report details real harm to the victims psyche. ! RA 11313 explicitly protects against harassment causing psychological and emotional distress! \n\n‚òÖ YOU (PROSECUTOR): This licensed psychologist's assessment documents clinical anxiety disorder, sleep disturbances, and workplace performance decline; those are measurable, serious impacts! \n\n‚òÖ YOU (PROSECUTOR): This evidence serves dual purposes: it demonstrates the SEVERITY of the harassment for criminal prosecution, proving this wasn't harmless contact, AND it provides foundation for civil damages! \n\n‚òÖ YOU (PROSECUTOR):  The Philippine law recognizes psychological trauma as REAL harm deserving legal protection! \n\n‚òÖ JUDGE: Powerfully stated, Counselor. Psychological harm is both real and legally cognizable.\n\n‚òÖ MS. MARIA: *emotionally* He destroyed my mental health for months. \n\n‚òÖ DEFENSE ATTORNEY SANTIAGO: *quietly* The harm is quite documented. \n\n‚òÖ Credibility Score: +5",
        wrongMsgs: [
          "‚úó YOU (PROSECUTOR): Your Honor, I agree psychological harm is less important than physical injury‚Ä¶\n\n‚úó DEFENSE ATTORNEY SANTIAGO: Your Honor, the PROSECUTION just agreed with my argument! They said that emotional distress doesn‚Äôt matter unless someone‚Äôs physically hurt  which basically destroys what they‚Äôre trying to prove!\n\n‚úó DEFENSE ATTORNEY SANTIAGO: Expert Psychological Report is THEIR evidence showing psychological damage! Are they saying their own evidence doesn't matter? \n\n‚úó DEFENSE ATTORNEY SANTIAGO: This is extraordinary, the prosecutor doesn't believe in the harm their own victim suffered! \n\n‚úó DEFENSE ATTORNEY SANTIAGO: How can they prosecute a case they don't believe in?\n\n‚úó JUDGE: Prosecution! Are you representing the victim or defending the accused? RA 11313 explicitly protects against psychological and emotional harm! \n\n‚úó JUDGE: You just sabotaged your own case by agreeing with the defense. Modern Philippine law recognizes psychological harm as serious injury!\n\n‚úó MS. MARIA: *shocked* You're saying what he did to my mental health doesn't matter?\n\n",
          "‚úó YOU (PROSECUTOR): Your Honor, the victim must prove permanent psychological disability‚Ä¶\n\n‚úó DEFENSE ATTORNEY SANTIAGO: Your Honor, the PROSECUTION creates impossible standards that would kill harassment laws! If permanent disability were required, people could be abused into  almost having serious injury without consequence.\n\n‚úó DEFENSE ATTORNEY SANTIAGO: RA 11313 protects against unwanted harassment REGARDLESS of injury severity! Expert Psychological Report shows serious harm, but even then the act of harassing someone is still unlawful even without proof of emotional damage.\n\n‚úó DEFENSE ATTORNEY SANTIAGO: The prosecutor's position would let my client harass people freely as long as he doesn't permanently disable them! This is absurd!\n\n‚úó JUDGE: Sustained. Harassment is criminal based on the conduct, not severity of resulting harm. The psychological evidence aggravates but doesn't enable prosecution. You've misunderstood the law, Counselor.\n\nMS. MARIA: So he could have kept harassing me as long as I didn't break completely?",
          "‚úó YOU (PROSECUTOR): Your Honor, actually this psychological report might be inadmissible hearsay‚Ä¶\n\n‚úó DEFENSE ATTORNEY SANTIAGO: With respect, your Honor,the prosecution now doubts its own proof! If they don't believe their expert psychological report is admissible, why did they present it? \n\n‚úó DEFENSE ATTORNEY SANTIAGO: Expert testimony from licensed professionals who personally examined patients is TEXTBOOK admissible evidence! The prosecutor either doesn't understand legal standards  or is so confused they're attacking their own exhibits! \n\n‚úó DEFENSE ATTORNEY SANTIAGO: This is professional incompetence on display!\n\n‚úó JUDGE: Prosecution! You presented this evidence, and now you're claiming it's inadmissible hearsay? \n\n‚úó JUDGE: Expert psychological assessments are clearly admissible under Philippine evidence rules! Are you trying to lose this case? Get your arguments straight!\n\n‚úó MS. MARIA: *bewildered* You brought this evidence and now you're saying it shouldn't be allowed?"
        ]
      },

      { // QUESTION 9
      preDialogues: [
          "YOU (PROSECUTOR): Your Honor, the initial upskirt photography incident at NAIA occurred on February 8, 2025. The victim, Maria, initially filed her complaint with the Lapu-Lapu City Prosecutor's Office, which dismissed it for lack of jurisdiction. ",
          "YOU (PROSECUTOR): She then successfully filed with the Pasay City Prosecutor's Office, which we are prosecuting today. ",
          "DEFENSE ATTORNEY SANTIAGO: Your Honor, why is the venue even relevant? It feels like they‚Äôre stretching for something here!‚Äù,
          "JUDGE: Prosecution, explain why jurisdiction was properly established in Pasay City.‚Äù,
          
        ],
        text: " The upskirt photography incident at NAIA was initially filed in Lapu-Lapu City but dismissed for lack of jurisdiction, then properly filed in Pasay City. Why does Pasay City have proper jurisdiction?",
        answers: [
          "Because the victim was traveling to Cebu",
          "Because all cybercrime cases must be filed in Metro Manila",
          "Because the crime occurred  within Pasay City's territorial jurisdiction",
          "Because the defendant resides in Pasay City"
        ],
        correct: 2,
        correctMsg: "‚òÖ YOU (PROSECUTOR): Your Honor! presents jurisdictional argument Territorial jurisdiction is fundamental criminal procedure! The crime must be prosecuted where it OCCURRED! \n\n‚òÖ YOU (PROSECUTOR): CCTV Footage of NAIA Terminal 3 's CCTV footage clearly shows its location 'NAIA Terminal 3, Pasay City‚Äô!\n\n‚òÖ YOU (PROSECUTOR): The upskirt photography happened within Pasay City's territorial boundaries, establishing that the case belongs here!\n\n‚òÖ YOU (PROSECUTOR): The Lapu-Lapu City Prosecutor was right to dismiss it for lack of jurisdiction because the crime didn't occur in their territory.\n\n‚òÖ YOU (PROSECUTOR): The victim's destination and defendant's residence are irrelevant. The criminal act occurred in Pasay City, so Pasay City will handle this case!\n\n‚òÖ JUDGE: Correctly argued, Counselor. Territorial jurisdiction follows the locus criminis.\n\n‚òÖ DEFENSE ATTORNEY SANTIAGO: *grudgingly* The venue is proper....\n\n‚òÖ Credibility Score: +5",
        wrongMsgs: [
          "‚úó YOU (PROSECUTOR): Your Honor, Pasay has jurisdiction because the victim was traveling to Cebu...\n\n‚úó DEFENSE ATTORNEY SANTIAGO: OBJECTION! The prosecution invents venue rules based on travel plans! Territorial jurisdiction depends on where crimes OCCUR, not where victims are GOING! \n\n‚úó DEFENSE ATTORNEY SANTIAGO: If the prosecutor's logic held, every crime against a traveler could be prosecuted in their destination city!   CCTV Footage of NAIA Terminal 3  shows the crime at NAIA Terminal 3 in PASAY CITY‚Äîthat's why Pasay has jurisdiction!  \n\n‚úó DEFENSE ATTORNEY SANTIAGO: The victim's Cebu destination is completely irrelevant! This prosecutor doesn't understand basic criminal procedure! \n\n‚úó JUDGE: Sustained. Victim destination doesn't establish jurisdiction. The crime location does‚ÄîNAIA in Pasay City. \n\n",
          "‚úó YOU (PROSECUTOR): Your Honor, all cybercrime cases must be filed in Metro Manila‚Ä¶\n\n‚úó DEFENSE ATTORNEY SANTIAGO: OBJECTION! The prosecutor is making up rules about where this case should be heard. First, this isn't mainly a cybercrime, it's VOYEURISM under RA 9995! \n\n‚úó DEFENSE ATTORNEY SANTIAGO: Second, even so,  cybercrimes aren't all filed in Manila! Territorial jurisdiction applies to all crimes!  The CCTV Footage of NAIA Terminal 3  shows a physical act‚Äîupskirt photography‚Äîat NAIA Terminal 3 in Pasay. \n\n‚úó DEFENSE ATTORNEY SANTIAGO: The crime occurred in Pasay City's territory, so Pasay City is the one who will handle the case ! \n\n‚úó DEFENSE ATTORNEY SANTIAGO: There's no magical rule funneling cases to Manila! This prosecutor fundamentally misunderstands Philippine jurisdiction! \n\n‚úó JUDGE: Sustained. No such blanket Manila jurisdiction exists. Basic territorial principles apply.",
          "‚úó YOU (PROSECUTOR): Your Honor, jurisdiction lies in Pasay because the defendant lives there‚Ä¶\n\n‚úó DEFENSE ATTORNEY SANTIAGO: OBJECTION! The prosecution confuses defendant residence with crime location! If residence determined jurisdiction, criminals could choose their trial locations by moving! Territorial jurisdiction is based on where crimes OCCUR!  \n\n‚úó DEFENSE ATTORNEY SANTIAGO:  The CCTV Footage of NAIA Terminal 3  shows the crime at NAIA Terminal 3 in Pasay City, that establishes venue, not where MR. Dwg lives!\n\n‚úó DEFENSE ATTORNEY SANTIAGO: The prosecutor's logic would let people simply move around to find a court they prefer?  This is a fundamental criminal procedure that the prosecutor apparently doesn't grasp! \n\n‚úó JUDGE: Sustained. Crime location establishes jurisdiction, not defendant residence. This is basic procedure, Counselor."
        ]
      },
      { // QUESTION 10
      preDialogues: [
          "JUDGE: Prosecution, you've presented,CCTV Footage of NAIA Terminal 3 showing the defendant photographing under a woman's skirt.",
          "JUDGE: Under which specific provision are you charging this conduct?"
        ],
        text: "The  CCTV Footage of NAIA Terminal 3  shows CCTV footage of the defendant taking an upskirt photograph at NAIA. Under which specific section of RA 9995 is this conduct prohibited?",
        answers: [
          "Section 4(a) - Taking photos under a person's clothing without consent",
          "Section 3(a) - Photo voyeurism in private places",
          "Section 5 - Penalties for distribution of voyeuristic materials",
          "Section 6 - Venue and jurisdiction provisions"
        ],
        correct: 0,
        correctMsg: "‚òÖ YOU (PROSECUTOR): Your Honor!  Section 4(a) of the Anti-Photo and Video Voyeurism Act explicitly prohibits taking photos or videos under a person's clothing without consent!\n\n‚òÖ YOU (PROSECUTOR): CCTV Footage of NAIA Terminal 3 's CCTV footage shows the defendant positioning his phone at an upward angle beneath the victim‚Äôs skirt at 2:15 PM. \n\n‚òÖ YOU (PROSECUTOR): And the photo itself proves it ‚Äì its data matches the time of the incident exactly. Moreover, a similar prosecution happened right here, involving a Cebu City official, establishing this behavior breaks the law as outlined in Section 4‚Äî\n\n‚òÖ JUDGE: That‚Äôs spot on, Counsel, Section 4(a) is the applicable provision.\n\n‚òÖ DEFENSE ATTORNEY: *shuffles papers nervously* The evidence is... concerning..\n\n‚òÖ Credibility Score: +5",
        wrongMsgs: [
          "‚úó YOU (PROSECUTOR): Your Honor, this violates Section 3(a) regarding voyeurism in private places...\n\n",
          "‚úó YOU (PROSECUTOR): Your Honor, Section 5 on distribution penalties applies...\n\n",
          "‚úó YOU (PROSECUTOR): Your Honor, Section 6 regarding venue and jurisdiction...\n\n"
        ]
      }
      // END
    ];

    function createKeyboard() {
      const keyboard = document.getElementById('keyboard');
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
      keyboard.innerHTML = '';
      letters.forEach(letter => {
        const btn = document.createElement('button');
        btn.className = 'key-button'; btn.textContent = letter;
        btn.onclick = () => { sounds.menuMove(); addLetter(letter); };
        keyboard.appendChild(btn);
      });
    }

    function addLetter(letter) { if (currentName.length < MAX_NAME_LENGTH) { currentName += letter; updateNameDisplay(); } }

    function updateNameDisplay() {
      document.getElementById('name-display').textContent = currentName || '';
      document.getElementById('backspace-btn').disabled = currentName.length === 0;
      document.getElementById('done-btn').disabled = currentName.length === 0;
      document.querySelectorAll('.key-button').forEach(btn => { btn.disabled = currentName.length >= MAX_NAME_LENGTH; });
    }

    document.getElementById('backspace-btn').onclick = () => { if (currentName.length > 0) { sounds.menuMove(); currentName = currentName.slice(0, -1); updateNameDisplay(); } };
    document.getElementById('quit-btn').onclick = () => { sounds.menuMove(); currentName = ''; updateNameDisplay(); };
    document.getElementById('done-btn').onclick = () => {
      if (currentName.length > 0) {
        sounds.menuSelect();
        playerName = currentName;
        document.getElementById('player-name').textContent = playerName;
        playBackgroundMusic();
        gsap.to('#name-screen', {
          opacity: 0, duration: 0.5, onComplete: () => {
            document.getElementById('name-screen').classList.add('hidden');
            gsap.set('#name-screen', { opacity: 1 });
            gameMode = 'walking';
          }
        });
      }
    };

    function initializeTipsScreen() {
    }

    function createTipCard(tip, category) {
    }

    function toggleTipCollection(tip, card) {
    }

    function updateCollectedCount() {
    }

    function showTipsScreen() {
    }

    function closeTipsScreen() {
    }

    document.getElementById('skip-tips-btn').onclick = () => {
    };

    document.getElementById('proceed-btn').onclick = () => {
    };

    function showInventory() {
      const inventoryContent = document.getElementById('inventory-content');
      inventoryContent.innerHTML = '';

      if (collectedTips.length === 0) {
        inventoryContent.innerHTML = '<div class="empty-inventory">* No resources collected.<br>* You skipped the library phase.</div>';
      } else {
        collectedTips.forEach(tip => {
          const item = document.createElement('div');
          item.className = 'inventory-item';
          let html = `<div class="inventory-item-title">${tip.title}</div>`;
          if (tip.subtitle) html += `<div class="inventory-item-subtitle">${tip.subtitle}</div>`;
          html += `<div class="inventory-item-content">${tip.content}</div>`;
          item.innerHTML = html;
          inventoryContent.appendChild(item);
        });
      }

      gsap.fromTo('#inventory-modal',
        { scale: 0.8, opacity: 0 },
        {
          scale: 1, opacity: 1, duration: 0.5, ease: "back.out(1.7)",
          onStart: () => { document.getElementById('inventory-modal').classList.add('active'); }
        }
      );
    }

    document.getElementById('close-inventory-btn').onclick = () => {
      sounds.menuSelect();
      gsap.to('#inventory-modal', {
        scale: 0.8, opacity: 0, duration: 0.3,
        onComplete: () => {
          document.getElementById('inventory-modal').classList.remove('active');
          gsap.set('#inventory-modal', { scale: 1, opacity: 1 });
        }
      });
    };

  let isTyping = false, currentText = '', targetText = '', charIndex = 0;

  // Per-question dialogue sequencing (e.g., JUDGE:, PROSECUTOR:, OPPOSITION:)
  let questionDialogues = [];
  let questionDialogueIndex = 0;
  let questionDialogueCallback = null;
  let inQuestionDialogue = false;
  let waitingForQuestionConfirm = false;
  let questionConfirmCallback = null;

    function typeText(text, element, callback) {
      targetText = text;
      currentText = '';
      charIndex = 0;
      isTyping = true;
      element.textContent = '';

      function typeChar() {
        if (charIndex < targetText.length) {
          if (charIndex % 3 === 0) sounds.textBlip(); // Less frequent beeps
          currentText += targetText[charIndex];
          element.textContent = currentText;
          charIndex++;
          setTimeout(typeChar, 20); // Faster typing for longer text
        } else {
          isTyping = false;
          if (callback) callback();
        }
      }
      typeChar();
    }

    function startDialogue() {
      gameMode = 'dialogue'; dialogueIndex = 0; dialogues = [...narratorDialogues]; currentDialoguePhase = 'narrator';
      const dialogueBox = document.getElementById('dialogue-box');
      gsap.fromTo('#dialogue-box', { opacity: 0, y: -20 }, {
        opacity: 1, y: 0, duration: 0.3,
        onStart: () => { dialogueBox.classList.add('active'); }
      });
      showNextDialogue();
    }

    function showNextDialogue() {
      if (dialogueIndex < dialogues.length) {
        const dialogue = typeof dialogues[dialogueIndex] === 'function' ? dialogues[dialogueIndex]() : dialogues[dialogueIndex];
        typeText(dialogue, document.getElementById('dialogue-text'));
        dialogueIndex++;
      } else {
        if (currentDialoguePhase === 'narrator') {
          dialogues = [...npcTipsDialogues];
          dialogueIndex = 0;
          currentDialoguePhase = 'npc';
          transitionToScene('library');
          showNextDialogue();
        } else if (currentDialoguePhase === 'npc') {
          gsap.to('#dialogue-box', {
            opacity: 0, duration: 0.3, onComplete: () => {
              document.getElementById('dialogue-box').classList.remove('active');
              showTipsMenu();
            }
          });
        } else if (currentDialoguePhase === 'tipInfo') {
          gsap.to('#dialogue-box', {
            opacity: 0, duration: 0.3, onComplete: () => {
              document.getElementById('dialogue-box').classList.remove('active');
              showTipsMenu();
            }
          });
        }
      }
    }

    function showTipsMenu() {
      document.getElementById('tips-choice-box').classList.add('active');
      gsap.fromTo('#tips-choice-box', { opacity: 0, y: -20 }, { opacity: 1, y: 0, duration: 0.3 });
    }

    // Show a sequence of small dialogues before a question (e.g., JUDGE:, PROSECUTOR:, OPPOSITION:)
    function showQuestionDialogues(lines, onComplete) {
      if (!lines || !lines.length) { onComplete && onComplete(); return; }
      questionDialogues = lines.slice();
      questionDialogueIndex = 0;
      questionDialogueCallback = onComplete || null;
      inQuestionDialogue = true;

      const dialogueBox = document.getElementById('dialogue-box');
      const battleBox = document.getElementById('battle-box');

      // Hide the battle box first so the dialogue appears alone (like showDialogueMessage does)
      gsap.to('#battle-box', {
        opacity: 0,
        duration: 0.2,
        onComplete: () => {
          if (battleBox) battleBox.classList.remove('active');

          gsap.fromTo('#dialogue-box', { opacity: 0, y: -20 }, {
            opacity: 1, y: 0, duration: 0.3,
            onStart: () => { dialogueBox.classList.add('active'); }
          });

          // start first line (may include speaker prefix like 'JUDGE: text')
          applySpeakerAndType(questionDialogues[questionDialogueIndex]);
        }
      });
    }

    function presentQuestionPrompt(q, onConfirm) {
      const dialogueBox = document.getElementById('dialogue-box');
      const battleBox = document.getElementById('battle-box');
      
      gsap.to('#battle-box', {
        opacity: 0,
        duration: 0.2,
        onComplete: () => {
          if (battleBox) battleBox.classList.remove('active');
          dialogueBox.classList.add('active');
          gsap.fromTo('#dialogue-box', { opacity: 0, y: -20 }, { opacity: 1, y: 0, duration: 0.3 });
          
          typeText(q.text, document.getElementById('dialogue-text'), () => {
            waitingForQuestionConfirm = true;
            questionConfirmCallback = onConfirm || null;
          });
        }
      });
    }

    function showNextQuestionDialogue() {
      questionDialogueIndex++;
      if (questionDialogueIndex < questionDialogues.length) {
        // show next (may include prefix)
        applySpeakerAndType(questionDialogues[questionDialogueIndex]);
      } else {
        // finished
        const dialogueBox = document.getElementById('dialogue-box');
        const battleBox = document.getElementById('battle-box');
        gsap.to('#dialogue-box', {
          opacity: 0, duration: 0.3, onComplete: () => {
            dialogueBox.classList.remove('active');
            inQuestionDialogue = false;

            // Restore the battle box visuals
            if (battleBox) {
              battleBox.classList.add('active');
              gsap.fromTo('#battle-box', { opacity: 0 }, { opacity: 1, duration: 0.3 });
            }

            if (questionDialogueCallback) {
              const cb = questionDialogueCallback;
              questionDialogueCallback = null;
              cb();
            }
          }
        });
      }
    }

    function applySpeakerAndType(line) {
      // If the line is a function (like your narratorDialogues entries), evaluate it now so it can use runtime values like playerName
      if (typeof line === 'function') {
        try { line = line(); } catch (e) { console.warn('error evaluating dialogue function', e); line = '' + line; }
      }
      const speakerLabelEl = document.getElementById('speaker-label');
      const dialogueBox = document.getElementById('dialogue-box');
      // Reset classes
      dialogueBox.classList.remove('judge', 'prosecutor', 'defense');
      speakerLabelEl.style.display = 'none';

  // Expect format: 'SPEAKER: actual text' (SPEAKER optional)
      const m = /^\s*([^:]{1,20}):\s*(.*)$/i.exec(line);
      let speaker = null;
      let text = line;
      if (m) { speaker = m[1].trim(); text = m[2].trim(); }

      if (speaker) {
        speakerLabelEl.textContent = speaker.toUpperCase();
        speakerLabelEl.style.display = 'inline-block';
        // quick mapping to CSS class
        const s = speaker.toLowerCase();
        if (s.includes('judge')) dialogueBox.classList.add('judge');
        else if (s.includes('prosecut') || s.includes('you') || s.includes('prosecutor')) dialogueBox.classList.add('prosecutor');
        else if (s.includes('defense') || s.includes('defendant')) dialogueBox.classList.add('defense');
      }

      // Type the text portion
      typeText(text, document.getElementById('dialogue-text'));
    }

    function showTipInfo(tipKey) {
      sounds.menuSelect();
      const tip = tipsInfo[tipKey];

      if (!collectedTips.find(t => t.id === tipKey)) {
        collectedTips.push({
          id: tipKey,
          title: tip.title,
          subtitle: tip.subtitle,
          content: tip.dialogue.replace('* ', '')
        });
      }

      gsap.to('#tips-choice-box', {
        opacity: 0, duration: 0.3, onComplete: () => {
          document.getElementById('tips-choice-box').classList.remove('active');

          dialogues = [tip.dialogue];
          dialogueIndex = 0;
          currentDialoguePhase = 'tipInfo';

          const dialogueBox = document.getElementById('dialogue-box');
          gsap.fromTo('#dialogue-box', { opacity: 0, y: -20 }, {
            opacity: 1, y: 0, duration: 0.3,
            onStart: () => { dialogueBox.classList.add('active'); }
          });
          showNextDialogue();
        }
      });
    }

    document.getElementById('vocab-btn').onclick = () => showTipInfo('vocab1');
    document.getElementById('legal1-btn').onclick = () => showTipInfo('legal1');
    document.getElementById('legal2-btn').onclick = () => showTipInfo('legal2');

    document.getElementById('ready-btn').onclick = () => {
      sounds.menuSelect();
      gsap.to('#tips-choice-box', {
        opacity: 0, duration: 0.3, onComplete: () => {
          document.getElementById('tips-choice-box').classList.remove('active');
          transitionToScene('courtroom', () => {
            startQuiz();
          });
        }
      });
    };

    function transitionToScene(sceneName, callback) {
      const libraryScene = document.getElementById('library-scene');
      const courtroomScene = document.getElementById('courtroom-scene');
      const transitionOverlay = document.getElementById('transition-overlay');

      const currentScene = !libraryScene.classList.contains('hidden') ? libraryScene :
        !courtroomScene.classList.contains('hidden') ? courtroomScene : null;

      gsap.to(transitionOverlay, {
        opacity: 1,
        duration: 0.4,
        ease: "power2.in",
        onComplete: () => {
          if (currentScene) {
            gsap.set(currentScene, { opacity: 0 });
            currentScene.classList.add('hidden');
          }

          const newScene = sceneName === 'library' ? libraryScene : courtroomScene;
          newScene.classList.remove('hidden');
          gsap.set(newScene, { opacity: 1 });

          gsap.to(transitionOverlay, {
            opacity: 0,
            duration: 0.6,
            delay: 0.2,
            ease: "power2.out",
            onComplete: callback
          });
        }
      });
    }

    function startQuiz() {
      gameMode = 'quiz';
      const enemySprite = document.getElementById('enemy-sprite'), battleBox = document.getElementById('battle-box');
      enemySprite.classList.add('active'); battleBox.classList.add('active');
      gsap.fromTo('#enemy-sprite', { scale: 0, rotation: 180 }, { scale: 1, rotation: 0, duration: 0.8, ease: "back.out(1.7)" });
      gsap.to('#enemy-sprite', { y: '-=20', duration: 2, repeat: -1, yoyo: true, ease: "sine.inOut" });
      gsap.fromTo('#battle-box', { y: 100, opacity: 0 }, { y: 0, opacity: 1, duration: 0.5 });
      loadQuestion(currentQuestionIndex);
    }

    function loadQuestion(index) {
      if (index >= questions.length) { victory(); return; }
      const q = questions[index], questionText = document.getElementById('question-text'), answerButtons = document.getElementById('answer-buttons');

      // If the question has a preDialogues array, show those lines first and then render the question
      if (Array.isArray(q.preDialogues) && q.preDialogues.length > 0) {
        showQuestionDialogues(q.preDialogues, () => {
          // after dialogues complete, present the question prompt and wait for confirmation before showing choices
          presentQuestionPrompt(q, () => { renderQuestionContent(q, questionText, answerButtons); });
        });
      } else {
        // Present the question prompt first; answers will show after pressing Z/ENTER
        presentQuestionPrompt(q, () => { renderQuestionContent(q, questionText, answerButtons); });
      }
    }

    function renderQuestionContent(q, questionText, answerButtons) {
      typeText(q.text, questionText);
      answerButtons.innerHTML = '';
      q.answers.forEach((answer, i) => {
        const btn = document.createElement('button');
        btn.className = 'answer-btn'; btn.textContent = '‚òÖ ' + answer;
        btn.onclick = () => checkAnswer(i);
        btn.onmouseenter = () => sounds.menuMove();
        gsap.fromTo(btn, { x: -50, opacity: 0 }, { x: 0, opacity: 1, duration: 0.3, delay: i * 0.1 });
        answerButtons.appendChild(btn);
      });
      answeringQuestion = false;
    }

    function checkAnswer(selectedIndex) {
      if (answeringQuestion) return;
      answeringQuestion = true;
      const q = questions[currentQuestionIndex], buttons = document.querySelectorAll('.answer-btn');
      buttons.forEach(btn => btn.disabled = true);

      if (selectedIndex === q.correct) {
        buttons[selectedIndex].classList.add('correct');
        sounds.correct();
        gsap.to('#enemy-sprite', { scale: 1.2, duration: 0.1, yoyo: true, repeat: 1 });
        score += 100;
        updateScore();
        // Support multi-part correct messages (array, function, or string with blank-line separators)
        let correctParts = [];
        if (Array.isArray(q.correctMsg)) {
          correctParts = q.correctMsg.slice();
        } else if (typeof q.correctMsg === 'function') {
          correctParts = [q.correctMsg];
        } else {
          correctParts = (q.correctMsg || '').split(/\n\s*\n+/).map(s => s.trim()).filter(Boolean);
        }

        if (correctParts.length > 1) {
          showQuestionDialogues(correctParts, () => {
            currentQuestionIndex++;
            loadQuestion(currentQuestionIndex);
          });
        } else {
          showDialogueMessage(correctParts[0] || q.correctMsg, () => {
            currentQuestionIndex++;
            loadQuestion(currentQuestionIndex);
          });
        }
      } else {
        buttons[selectedIndex].classList.add('wrong');
        buttons[q.correct].classList.add('correct');
        sounds.wrong();
        gsap.to('#game-container', { x: '+=10', duration: 0.05, yoyo: true, repeat: 5, onComplete: () => gsap.set('#game-container', { x: 0 }) });
        gsap.to('#enemy-sprite', { scale: 1.3, rotation: 15, duration: 0.2, yoyo: true, repeat: 1, ease: "power2.inOut" });
        currentHP -= 5;
        updateHP();

        // Get the specific wrong message for this answer
        let wrongMsgIndex = selectedIndex;
        if (selectedIndex > q.correct) {
          wrongMsgIndex = selectedIndex - 1;
        }
        const wrongMessage = q.wrongMsgs[wrongMsgIndex];

        if (currentHP <= 0) {
          setTimeout(gameOver, 1500);
        } else {
          // If the wrong message contains multiple speaker blocks separated by blank lines,
          // split them and show each as a separate press-to-advance dialogue using showQuestionDialogues.
          const parts = (wrongMessage || '').split(/\n\s*\n+/).map(s => s.trim()).filter(Boolean);
          if (parts.length > 1) {
            showQuestionDialogues(parts, () => {
              currentQuestionIndex++;
              loadQuestion(currentQuestionIndex);
            });
          } else {
            showDialogueMessage(wrongMessage, () => {
              currentQuestionIndex++;
              loadQuestion(currentQuestionIndex);
            });
          }
        }
      }
    }

    function showDialogueMessage(text, callback) {
      const dialogueBox = document.getElementById('dialogue-box');
      const battleBox = document.getElementById('battle-box');

      // Hide battle box first
      gsap.to('#battle-box', {
        opacity: 0,
        duration: 0.2,
        onComplete: () => {
          battleBox.classList.remove('active');

          // Show dialogue box
          dialogueBox.classList.add('active');
          gsap.fromTo('#dialogue-box',
            { opacity: 0, y: 20 },
            { opacity: 1, y: 0, duration: 0.3 }
          );

          // Type the text (faster for longer messages)
          typeText(text, document.getElementById('dialogue-text'), () => {
            // Wait longer for longer messages
            const waitTime = text.length > 300 ? 4000 : 2500;
            setTimeout(() => {
              gsap.to('#dialogue-box', {
                opacity: 0,
                duration: 0.3,
                onComplete: () => {
                  dialogueBox.classList.remove('active');

                  // Show battle box again
                  battleBox.classList.add('active');
                  gsap.fromTo('#battle-box',
                    { opacity: 0 },
                    {
                      opacity: 1, duration: 0.3, onComplete: () => {
                        if (callback) callback();
                      }
                    }
                  );
                }
              });
            }, waitTime);
          });
        }
      });
    }

    function updateHP() {
      document.getElementById('current-hp').textContent = currentHP;
      const percentage = (currentHP / maxHP) * 100;
      gsap.to('#hp-bar', { width: percentage + '%', duration: 0.5, ease: "power2.out" });
      if (percentage <= 25) document.getElementById('hp-bar').style.backgroundColor = '#ff0000';
    }

    function updateScore() {
      gsap.to(document.getElementById('score'), { innerText: score, duration: 0.5, snap: { innerText: 1 }, ease: "power2.out" });
    }

    // Ending tier configuration based on credibility score
const ENDING_TIERS = {
  ACE: { 
    min: 45, 
    title: '‚òÖ ACE PROSECUTOR ‚òÖ', 
    rank: 'S',
    dialogues: [
      "JUDGE: *strikes gavel with finality* The court will now render its verdict based on the evidence and arguments presented.",
      `JUDGE: Based on the overwhelming evidence presented by the prosecution, this court finds the defendant, Mr. Dwg, GUILTY on all counts:
      
      - GUILTY of Gender-based Online Sexual Harassment under RA 11313 Section 4
      - GUILTY of Photo Voyeurism under RA 9995 Section 4(a)
      - GUILTY of violating the Safe Spaces Act provisions
            
      The defendant's systematic harassment of Ms. Patricia Santos over six months, combined with the deplorable upskirt photography at NAIA Terminal 3, represents a clear pattern of predatory behavior.`,
            () => `JUDGE: Attorney ${playerName}, your prosecution was nothing short of exemplary. Every statute cited was precise, every piece of evidence meticulously presented, and every legal argument devastatingly effective.`,
            "DEFENSE ATTORNEY SANTIAGO: *extends hand* Masterful prosecution. You may have presented an airtight case to damage my case record, but we'll see if it's just beginner's luck. You have my regards‚Äîthis is what competent advocacy looks like. *applauds*",
            `‚òÖ ACHIEVEMENT UNLOCKED: "CHAMPION OF JUSTICE" ‚òÖ

    The Department of Justice sends formal commendation. You're invited to train prosecutors on cybercrime cases nationwide. Media coverage highlights your expert handling of gender-based online harassment prosecution.
    
    Your name is being recommended for the Anti-Cybercrime Task Force!`
        ]
  },
  
  SKILLED: { 
    min: 35, 
    title: '‚òÖ SKILLED PROSECUTOR ‚òÖ', 
    rank: 'A',
    dialogues: [
      "JUDGE: *strikes gavel* The court has reached a verdict after careful deliberation.",
      `JUDGE: This court finds the defendant GUILTY on the primary charges:
      
      - GUILTY of Gender-based Online Sexual Harassment under RA 11313 Section 4
      - GUILTY of Photo Voyeurism under RA 9995 Section 4(a)
            
      While some procedural issues arose during trial, the core evidence was compelling and properly presented.`,
            () => `JUDGE: Attorney ${playerName}, you demonstrated strong legal acumen. A few stumbles in statute citation, but overall a solid prosecution that achieved justice.`,
            "DEFENSE ATTORNEY SANTIAGO: *nods respectfully* Well fought, Counselor. You had me worried several times. With more experience, you'll be formidable.",
            `‚òÖ ACHIEVEMENT UNLOCKED: "RISING STAR" ‚òÖ

    Your supervisor notes your strong performance. You're assigned more complex cases and recommended for advanced cybercrime law training.

    Local legal journals mention your successful prosecution of this high-profile case.`
    ]
  },
  COMPETENT: { 
    min: 25, 
    title: '‚òÖ COMPETENT PROSECUTOR ‚òÖ', 
    rank: 'B',
    dialogues: [
      "JUDGE: *strikes gavel* After reviewing all evidence, the court renders the following verdict.",
      `JUDGE: The defendant is found GUILTY on the main charge:
      
      - GUILTY of Gender-based Online Sexual Harassment under RA 11313 Section 4
      
      However, the voyeurism charge under RA 9995 resulted in a lesser conviction due to procedural concerns raised by the defense.`,
        () => `JUDGE: Attorney ${playerName}, justice was served today, though your case had vulnerabilities. I recommend reviewing the specific provisions of RA 9995 before your next similar case.`,
        "DEFENSE ATTORNEY SANTIAGO: *brief nod* You got the conviction, but you made it harder on yourself than necessary. Study more. The law rewards precision.",
        `‚òÖ ACHIEVEMENT UNLOCKED: "JUSTICE SERVED" ‚òÖ

        Your case is won, and the victim receives some measure of justice. Your supervisor provides feedback on areas for improvement, particularly on statute specificity and evidence presentation.
        
        You're cleared to continue handling standard cybercrime cases.`
    ]
  },
  STRUGGLING: { 
    min: 15, 
    title: '‚òÖ STRUGGLING PROSECUTOR ‚òÖ', 
    rank: 'C',
    dialogues: [
      "JUDGE: *strikes gavel with visible concern* This court has deliberated extensively given the... complications during trial.",
      `JUDGE: The defendant is found GUILTY on reduced charges:
      
      - GUILTY of Online Harassment (lesser included offense)
            
      The primary charges under RA 11313 Section 4 and RA 9995 Section 4(a) could not be sustained due to significant evidentiary and procedural issues presented by the prosecution.`,
            () => `JUDGE: Attorney ${playerName}, while you secured a conviction, your numerous legal errors nearly resulted in dismissal. This performance is concerning for someone representing the People.`,
            "DEFENSE ATTORNEY SANTIAGO: *barely conceals smirk* Lucky for you the evidence spoke for itself, because your arguments certainly didn't. Hit the law books, rookie.",
            `‚òÖ ACHIEVEMENT: "NARROW ESCAPE" ‚òÖ

      Your supervisor schedules a formal review meeting. You're required to complete remedial training on RA 11313, RA 9995, and proper evidence presentation before handling cybercrime cases again.
      
      The victim's family expresses disappointment at the reduced charges.`
    ]
  },
  INADEQUATE: { 
    min: 0, 
    title: '‚òÖ INADEQUATE PERFORMANCE ‚òÖ', 
    rank: 'D',
    dialogues: [
      "JUDGE: *strikes gavel heavily* This has been one of the most troubling prosecutions this court has witnessed.",
      `JUDGE: Due to the prosecution's repeated misidentification of applicable statutes, improper evidence handling, and fundamental misunderstanding of the legal framework...

      This court has no choice but to find the defendant GUILTY only on the most basic charge:
            
      - GUILTY of Unjust Vexation (minor offense)
            
      All major charges are DISMISSED due to prosecutorial incompetence.`,
            () => `JUDGE: Attorney ${playerName}, your performance was unacceptable. The victim deserved better representation. I'm recommending a formal review of your qualifications.`,
            "DEFENSE ATTORNEY SANTIAGO: *shakes head* I didn't even need to try. You did my job for me. Please don't practice law until you actually learn it.",
            `‚òÖ WARNING: "PROFESSIONAL REVIEW REQUIRED" ‚òÖ
      
      Your law license is under review. You're immediately suspended from handling any cybercrime cases and must complete comprehensive retraining.
      
      The victim files a complaint against you with the Integrated Bar of the Philippines.
      
      The Department of Justice opens an investigation into your competence.`
    ]
  }
};

    function getEndingTier(finalScore) {
      if (finalScore >= ENDING_TIERS.ACE.min) return ENDING_TIERS.ACE;
      if (finalScore >= ENDING_TIERS.SKILLED.min) return ENDING_TIERS.SKILLED;
      if (finalScore >= ENDING_TIERS.COMPETENT.min) return ENDING_TIERS.COMPETENT;
      if (finalScore >= ENDING_TIERS.STRUGGLING.min) return ENDING_TIERS.STRUGGLING;
      return ENDING_TIERS.INADEQUATE;
    }
    
    function victory() {
      gameMode = 'victory'; 
      sounds.victory();
      
      gsap.to('#battle-box', { 
        opacity: 0, y: 50, duration: 0.5, 
        onComplete: () => { document.getElementById('battle-box').classList.remove('active'); } 
      });
      
      gsap.to('#enemy-sprite', { 
        scale: 0, rotation: 360, duration: 0.8, 
        onComplete: () => { document.getElementById('enemy-sprite').classList.remove('active'); } 
      });
      
      // Get the appropriate ending tier based on CREDIBILITY (currentHP), not score
      const ending = getEndingTier(currentHP);
      
      // Process dialogues with playerName function evaluation
      const processedDialogues = ending.dialogues.map(dialogue => {
        if (typeof dialogue === 'function') {
          return dialogue();
        }
        return dialogue;
      });
      
      // Show ending dialogue sequence
      showEndingDialogues(processedDialogues, ending, () => {
        // After dialogues, show the final victory screen
        showFinalVictoryScreen(ending);
      });
    }

    function showEndingDialogues(dialogues, ending, onComplete) {
      let currentIndex = 0;
      
      const dialogueBox = document.getElementById('dialogue-box');
      dialogueBox.classList.add('active');
      gsap.fromTo('#dialogue-box', 
        { opacity: 0, y: -20 }, 
        { opacity: 1, y: 0, duration: 0.3 }
      );
      
      function showNext() {
        if (currentIndex < dialogues.length) {
          const dialogue = dialogues[currentIndex];
          applySpeakerAndType(dialogue);
          currentIndex++;
          
          // Set up for next dialogue
          const checkForNext = setInterval(() => {
            if (!isTyping) {
              clearInterval(checkForNext);
              
              // Wait for player input to continue
              const continueHandler = (e) => {
                if (e.key === 'z' || e.key === 'Z' || e.key === 'Enter') {
                  sounds.menuSelect();
                  document.removeEventListener('keydown', continueHandler);
                  showNext();
                }
              };
              document.addEventListener('keydown', continueHandler);
              
              // Mobile support
              const mobileHandler = () => {
                sounds.menuSelect();
                document.getElementById('mobile-action').removeEventListener('touchstart', mobileHandler);
                document.removeEventListener('keydown', continueHandler);
                showNext();
              };
              document.getElementById('mobile-action').addEventListener('touchstart', mobileHandler, { once: true });
            }
          }, 100);
        } else {
          // All dialogues shown, fade out and show final screen
          gsap.to('#dialogue-box', {
            opacity: 0, duration: 0.3,
            onComplete: () => {
              dialogueBox.classList.remove('active');
              onComplete();
            }
          });
        }
      }
  
      showNext();
    }

  function showFinalVictoryScreen(ending) {
      const victoryScreen = document.getElementById('victory-screen');
      victoryScreen.querySelector('h2').textContent = ending.title;
      
      // Update or create rank display
      let rankDisplay = victoryScreen.querySelector('.rank-display');
      if (!rankDisplay) {
        rankDisplay = document.createElement('div');
        rankDisplay.className = 'rank-display';
        victoryScreen.insertBefore(rankDisplay, victoryScreen.querySelector('p'));
      }
      rankDisplay.textContent = `RANK: ${ending.rank}`;
      
      // Update message with credibility instead of score
      const messageP = victoryScreen.querySelectorAll('p')[0];
      const lastDialogue = ending.dialogues[ending.dialogues.length - 1];
      messageP.textContent = lastDialogue.replace(/‚òÖ|ACHIEVEMENT.*?:|WARNING.*?:/g, '').trim();
      
      // Show credibility score instead of regular score
      const finalScoreElement = document.getElementById('final-score-victory');
      finalScoreElement.parentElement.innerHTML = `Final Credibility: <span id="final-score-victory">${currentHP}</span> / ${maxHP}<br>Cases Won: <span>${score}</span> points`;
      
      gsap.fromTo('#victory-screen', 
        { scale: 0, rotation: -180 }, 
        {
          scale: 1, rotation: 0, duration: 1, ease: "back.out(1.7)",
          onStart: () => { victoryScreen.classList.add('active'); }
        }
      );
    }

    function gameOver() {
      gameMode = 'gameover';
      gsap.to('#battle-box', { opacity: 0, duration: 0.5, onComplete: () => { document.getElementById('battle-box').classList.remove('active'); } });
      gsap.to('#enemy-sprite', { scale: 1.5, opacity: 0, duration: 1, onComplete: () => { document.getElementById('enemy-sprite').classList.remove('active'); } });
      document.getElementById('final-score-gameover').textContent = score;
      gsap.fromTo('#gameover-screen', { opacity: 0, y: 50 }, {
        opacity: 1, y: 0, duration: 1,
        onStart: () => { document.getElementById('gameover-screen').classList.add('active'); }
      });
    }

    function resetGame() {
      sounds.menuSelect();
      score = 0; currentHP = maxHP; currentQuestionIndex = 0; gameMode = 'walking'; dialogueIndex = 0;
      answeringQuestion = false; currentDialoguePhase = 'narrator'; dialogues = []; collectedTips = [];
      updateScore(); updateHP();
      gsap.to('.end-screen.active', {
        opacity: 0, duration: 0.5, onComplete: () => {
          document.querySelectorAll('.end-screen').forEach(s => s.classList.remove('active'));
          gsap.set('.end-screen', { opacity: 1 });
        }
      });
      document.getElementById('battle-box').classList.remove('active');
      document.getElementById('enemy-sprite').classList.remove('active');
      document.getElementById('tips-choice-box').classList.remove('active');

      gsap.set('#library-scene', { opacity: 0 });
      gsap.set('#courtroom-scene', { opacity: 0 });
      document.getElementById('library-scene').classList.add('hidden');
      document.getElementById('courtroom-scene').classList.add('hidden');

      gsap.killTweensOf('#enemy-sprite');
      gsap.set('#enemy-sprite', { scale: 1, rotation: 0, y: 0 });
      gsap.set('#battle-box', { opacity: 1, y: 0 });
      player.x = canvas.width / 2; player.y = canvas.height / 2;
    }

    document.getElementById('restart-victory').onclick = resetGame;
    document.getElementById('restart-gameover').onclick = resetGame;
    document.getElementById('act-btn').onclick = () => {
      if (gameMode === 'quiz' && !answeringQuestion) {
        sounds.menuSelect();
        showDialogueMessage("* You tried to ACT...", null);
      }
    };
    document.getElementById('item-btn').onclick = () => {
      if (gameMode === 'quiz' && !answeringQuestion) {
        sounds.menuSelect();
        showInventory();
      }
    };
    document.getElementById('mercy-btn').onclick = () => {
      if (gameMode === 'quiz' && !answeringQuestion) {
        sounds.menuSelect();
        showDialogueMessage("* The enemy refuses your mercy!", null);
      }
    };

    document.addEventListener('keydown', (e) => {
      if (gameMode === 'nameEntry') {
        if (e.key.length === 1 && /[a-zA-Z]/.test(e.key)) { e.preventDefault(); sounds.menuMove(); addLetter(e.key.toUpperCase()); }
        else if (e.key === 'Backspace') { e.preventDefault(); document.getElementById('backspace-btn').click(); }
        else if (e.key === 'Enter') { e.preventDefault(); if (currentName.length > 0) document.getElementById('done-btn').click(); }
        return;
      }
      keys[e.key] = true;

      // If we're in a per-question dialogue sequence, handle Z/Enter here and don't fall through
      if (inQuestionDialogue && (e.key === 'z' || e.key === 'Z' || e.key === 'Enter')) {
        e.preventDefault();
        if (isTyping) {
          // finish typing immediately
          isTyping = false; 
          document.getElementById('dialogue-text').textContent = targetText;
        } else {
          sounds.menuSelect();
          showNextQuestionDialogue();
        }
        return;
      }

      // If we're waiting for the player to press Z/ENTER to show the question choices
      if (waitingForQuestionConfirm && (e.key === 'z' || e.key === 'Z' || e.key === 'Enter')) {
        e.preventDefault();
        if (isTyping) {
          // finish typing immediately
          isTyping = false;
          document.getElementById('dialogue-text').textContent = targetText;
        } else {
          sounds.menuSelect();
          waitingForQuestionConfirm = false;
          const dialogueBox = document.getElementById('dialogue-box');
          const battleBox = document.getElementById('battle-box');
          gsap.to('#dialogue-box', {
            opacity: 0, duration: 0.3, onComplete: () => {
              dialogueBox.classList.remove('active');
              // restore battle box visuals and then run the callback to render choices
              if (battleBox) {
                battleBox.classList.add('active');
                gsap.fromTo('#battle-box', { opacity: 0 }, { opacity: 1, duration: 0.3 });
              }
              if (questionConfirmCallback) {
                const cb = questionConfirmCallback;
                questionConfirmCallback = null;
                cb();
              }
            }
          });
        }
        return;
      }

      if ((e.key === 'z' || e.key === 'Z' || e.key === 'Enter')) {
        e.preventDefault();
        if (gameMode === 'walking' && canInteract) { sounds.menuSelect(); startDialogue(); }
        else if (gameMode === 'dialogue' && !isTyping) { sounds.menuSelect(); showNextDialogue(); }
        else if (gameMode === 'dialogue' && isTyping) { isTyping = false; document.getElementById('dialogue-text').textContent = targetText; }
      }
    });
    document.addEventListener('keyup', (e) => { keys[e.key] = false; });

    function update() {
      if (gameMode === 'walking') {
        if (keys['ArrowUp'] || keys['w'] || keys['W']) player.y -= player.speed;
        if (keys['ArrowDown'] || keys['s'] || keys['S']) player.y += player.speed;
        if (keys['ArrowLeft'] || keys['a'] || keys['A']) player.x -= player.speed;
        if (keys['ArrowRight'] || keys['d'] || keys['D']) player.x += player.speed;
        if (mobileKeys.up) player.y -= player.speed;
        if (mobileKeys.down) player.y += player.speed;
        if (mobileKeys.left) player.x -= player.speed;
        if (mobileKeys.right) player.x += player.speed;
        player.x = Math.max(player.size, Math.min(canvas.width - player.size, player.x));
        player.y = Math.max(player.size, Math.min(canvas.height - player.size, player.y));
        const dist = Math.hypot(player.x - npc.x, player.y - npc.y);
        canInteract = dist < 80;
      }
    }

    function draw() {
      ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
      if (gameMode === 'walking' || gameMode === 'dialogue') {
        ctx.fillStyle = npc.color; ctx.fillRect(npc.x - npc.size / 2, npc.y - npc.size / 2, npc.size, npc.size);
        ctx.fillStyle = '#fff'; ctx.font = '10px "Press Start 2P"'; ctx.textAlign = 'center';
        ctx.fillText('QUIZ MASTER', npc.x, npc.y - npc.size - 5);
        ctx.fillStyle = player.color; ctx.fillRect(player.x - player.size / 2, player.y - player.size / 2, player.size, player.size);
        if (canInteract && gameMode === 'walking') {
          ctx.fillStyle = '#ff8c00'; ctx.font = '8px "Press Start 2P"';
          ctx.fillText(isMobile ? 'Press Z Button' : 'Press Z', player.x, player.y - 30);
        }
      }
    }

    function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }

    createKeyboard();
    updateNameDisplay();
    updateHP();
    updateScore();
    window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
    gameLoop();
  </script>
  </body>
</html>
